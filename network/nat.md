## NAT 越え

- NAPT は IP ヘッダと TCP ヘッダを書き換えるため，以下の通信ではうまくいかない

1. IP の上位層がポート番号を持たないプロトコル
1. アプリケーション層に送信元ホストの IP アドレスやポート番号の情報を格納している

## IP の上位層がポート番号を持たないプロトコル

- 解決方法は以下

  - UDP ヘッダの挿入

    - 宛先で UDP ヘッダを削除する必要がある

  - パスするー
    - IP ヘッダのプロトコルフィールどをみて，上位層がポート番号を持たないことをみて IP ヘッダの送信元 IP アドレスだけ書き換え，ポート番号を書き換えずに転送する

- このケースに該当するプロトコルとしては IPsec がある
- IPsec パケットの ESP ヘッダはポート番号を持たないので以下の方法で解決する必要がある

## NAT とラバーサル

## VPN パスするー

## アプリケーション層に送信元ホストの IP アドレスやポート番号の情報を格納しているケース

- sip がこのケースに該当する
- VoIP のは SIP を用いてセッションを作成し，RTP によって通話をする
- セッションを生成する際，端末同士は直接やり取りせず，プロキシ機能を持つ SIP サーバを経由することができる
- SIP サーバを経由する場合，TCP コネクションは SIP サーバで終端する
- セッション生成時は SIP サーバと，通話セッション時は相手端末と通信することになる

  - この通話セッションはセッション生成時のアプリケーションデータにある IP アドレスを使って直接通信を行うことになるが，NAT によって書き換えられないため困る

- 解決方法としては，通話セッションを中継する機能を持つ VoIP ゲートウェイを用意して，これにグローバル IP アドレスを持たせる
- セッション生成時に通知し合う IP アドレスを VoIP ゲートウェイのグローバル IP アドレスに変換する
