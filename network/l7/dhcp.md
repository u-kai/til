# DHCP

- DHCP は UDP の上位プロトコル
- DHCP サーバはポート番号 67 番，DHCP クライアントはポート番号 68 番

## DHCP による 設定情報の割り当て順序

- クライアントの起動時， IP アドレス，サブネットマスクは 0.0.0.0 が設定されている
- DHCP サーバとのやり取りは通常，制限ブロードキャストアドレス(255.255.255.255)が用いられる

## 初期リースの取得

- クライアントはサーバを見つけるため，DHCPDISCOVER を送信する
- サーバはクライアントに IP アドレスを提供するために，DHCPOFFER を送信する
  - サーバが複数ある場合は DHCPOFFER が複数とぶ
- クライアントは提供された IP アドレスの割り当てを要求するため，DHCPREQUEST を送信する
  - 複数のサーバから DHCPOFFER お w 受信した場合，その中から一つを選び提供された IP アドレスやサーバ ID をセットして送信する
- サーバは確認応答として DHCPACK を送信する

  - この際に提供した IP アドレスが割り当て可能かどうかをチェックしてこの時点で IP アドレスが割り当て不能であった場合 DHCPNACK を送信する

- リース期間の残り半分を過ぎていた場合は自動的にリースの更新を行い，再度同じ IP アドレスを要求する

  - この場合は DHCPREQUEST から DHCPACK をされるという流れ

- クライアントが IP アドレスのリース期間前に IP アドレスの使用を終了するときは，サーバに DHCPRELEASE パケットをユニキャストで送信する
  - このパケットを受け取ったサーバは IP アドレスを解放してプールに戻す
  - なおサーバはこのパケットに対して確認応答を返さない

## IP アドレス重複の検出

- DHCP クライアントは DHCP サーバから設定情報を受け取った後，GARP を送信し，IP アドレスの重複チェックを行う
- これは手動による設定などで IP アドレスが同一サブネット内に重複してしまう可能性があるため

## リレーエージェント

- 同一ブロードキャストドメインにサーバがいない場合に使用するもの
- リレーエージェントには DHCP サーバの IP アドレスを先に登録しておく必要がある
- このときサーバはクライアントからの要求がリレーエージェントを経由したものであることを識別すること

  - そしてクライアントが所属するサブネットネットワークの中から適切な IP アドレスを提供するため，ユニキャストパケットを用いて DHCP リレーエージェントに応答する

- リレーエージェントが DHCP リレー情報オプションをサポートしている時，DHCP クライアントから受け取った DHCP パケットにリレーエージェント固有の情報を付加して DHCP サーバに転送することができる
- 付加情報は 2 つ
  - リモート ID サブオプションと呼ばれるリレーエージェント(l3sw)の MAC アドレス
  - 回線 ID サブオプションと呼ばれる DHCP クライアントからのパケットを受信したポート番号など

## DHCP スヌーピんぐ

- SW が持つ機能
- 正規の DHCP サーバから IP アドレスが割り当てられた端末だけ通信を許可する機能
- DHCP サーバを経由するフレームを監視し，SW を経由した通信を正規の接続先と許可されたクライアントにのみ許可する
- この機能を動作させると，SW のポートは Untrusted ポートと Trusted ポートの 2 種類になる

  - 機能を有効化すると全てのポートは一旦 UnTrusted ポートになる

- Untrusted ポートは許可されたクライアントのみ通信を許可するポート
  - 許可されたクライアントのこと
- Trusted ポートは無条件に通信を許可するポート
  - 正規の接続先のこと
- 正規の DHCP サーバからクライアントが IP アドレスを割り当てられた後，SW は当該クライアントの IP アドレス，MAC アドレス，接続しているポート番号などをバインディングデータベースに登録する

- 許可されていないクライアントは正規の DHCP サーバとの IP アドレス割り当ての通信を除き，一才の通信が遮断される
