# SIP(Session Initiation Protocol)

- 端末間でセッションの生成，変更，転送，切断を行うプロトコル
- インスタントメッセージ機能はチャットのように利用者間でテキスト情報を交換するための機能
- イベント通知機能はイベントを通知する側とそのイベントを購読する側とを事前に登録しておき，通知側 UA でイベントが発生するたびに勾配側 UA にイベントが通知される機能
  - Teams の利用中，退出中などのステータス機能みたい利用例が書いてあった？

## SDP

- リアルタイムデータの通信を始める前に上位アプリケーション間でどのような通信を行うのかについて，情報を交換しておく必要がある

  - UA の IP アドレス
  - リアルタイムデータ転送用プロトコルが使用するポート番号
  - 音声や映像といったメディアの種別，およびそのメディアで用いられる暗号化方式

- 上記のような情報を一まとまりにしたのが SIP の規定するセッション
- セッションの記述方法を規定したものが SDP(Session Description Protocol)

## RTP

- 音声や映像などリアルタイム性のあるデータをストリーミング配信する仕組みを備えたプロトコル
- 送信ホストはシーケンス番号とタイムスタンプをパケットごとに付与している
- 受信ホストはパケット間の時間差を調整し，リアルタイム性を確保しながらデータを再生することができる

## SIP の構成要素

- UA

  - UA の識別には SIP URI が用いられる
  - その書式は sip:利用者識別子@ドメイン名
  - 利用者識別子の部分には電話番号を入れることができる
  - 同一ドメイン内の通信であれば@ドメイン名を省略しても良い

- SIP サーバ
  - UA で電話をかける時，発呼する側は着呼する側の電話番号や利用者識別子を知っている
  - このときもしも着呼 UA の IP アドレスを知っていれば UA 間で SIP 通信を直接やりとりし，セッションを生成できるため SIP サーバーは不要
  - IP アドレスを知らない場合，UA 間のセッション生成を仲介するために SIP サーが必要となる
  - SIP サーバを用いる場合，UA は自分の利用者識別子，自分の IP アドレスを含む登録メッセージを SIP サーバに事前に送信しておく
    - この時 REGISTER リクエストが用いられる
    - SIP サーバはこれを受信し，自分が仲介する全ての UA について位置情報(SIP URI に IP アドレスを対応づけた情報)，を登録しておく

## SIP のメッセージ

- SIP のメッセージの種類には発呼側から着呼側に対するリクエストと，着呼側から発呼がわに返信するリクエストがある

### リクエスト

- セッション制御
  - INVITE
    - セッションの生成を要求する
  - ACK
    - セッションの生成を確認する
  - BYE
    - セッションを切断する
  - CANCEL
    - 完了していないリクエストを取り消す
  - OPTIONS
    - サーバの機能を問い合わせる
  - REGISTER
    - 位置情報の登録を要求する
  - INFO
    - セッションの状態を通知する
  - re-INVITE
    - セッションを変更する
  - REFEER
    - 通知を転送するため，セッションを切り替える
- インスタントメッセージ
  - MESSAGE
    - インスタントメッセージの通知
- イベント通知
  - SUBSCRIBE
    - プレゼンスサーバに対し，プレゼンス情報の勾配を申し込む
  - PUBLISH
    - プレゼンス情報をプレゼンスサーバに登録する
  - NOTIFY
    - プレゼンスサーバが購買者にプレゼンス情報を通知する

### レスポンス

- Provisional(暫定応答)
  - 100
    - Trying
    - 処理中
  - 180
    - Ringing
    - 着呼を呼び出し中
- Final(最終応答)
  - 200
    - OK
    - 成功

## Via フィールドの働き

- Via フィールドはリクエストが経由したパスを示している
- まず送信もと UA が自分の IP アドレスを格納した Via フィールドを記述する
- SIP サーバーはリクエストを中継する際，自分を経由したことを示すために，Via フィールドを一行追加する
  - 追加する位置は既存の Via フィールドの上位
- 宛先 UA はレスポンスを返信する際，受け取った Via フィールドをそのままヘッダに記述する
- そして VIa フィールドの最上位に格納されたホストにレスポンスを返す
- SIP サーバはレスポンスを中継する前に，Via フィールドの最上位を削除し，SIP サーバではなく送信もとの IP が最上位になるように Via フィールドを編集する
