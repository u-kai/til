# ストレージネットワーキング

- SAN(Storage Area Network)と NAS(Network Attached Storage)がある
- SAN のストレージデバイスはサーバーに直接接続された SCSI のストレージデバイスと機能的に同等

  - ホストとロジカルユニット間のデータのやり取りには SCSI コマンドを使用し，ブロック単位でアクセスしている

- NAS はファイルサーバーと機能的に同等

  - ネットワーク上のストレージに対して，ファイル単位でアクセスしている

- ホストと SAN のストレージはファイバチャネルスイッチを介して接続している
  - ホストのインターフェイスは HBA(ホストバスアダプタ)
  - ストレージのインターフェイスはストレージコントローラ
- SAN のストレージには物理ディスクが何台も搭載されている
  - RAID コントロールにより物理ディスクを束ねた上で各ホストが必要とする要領に基づき，全体をいくつかに区分する
  - 区分された個々の領域が外部に提供する論理的なディスクとなり，このディスクをロジカルユニットと呼ぶ
  - この LU に対し，ホストは SCSI コマンドを使用してブロック単位でアクセスする
- 一方ホストと NAS は通常のスイッチを介して接続している
  - NAS は IP アドレスを持っている

## ファイバチャネル

- ANSI の T11 で標準化されたデータ転送の規格
- 接続形態にはポイントツーポイント型，ファブリック型，調停ループ型があるが主に使われているのはファブリック型
- ファブリック型は一台のスイッチに対して，1 台以上のホストが接続される構成
  - スイッチ同士を接続することもできる

## WWN とポートアドレス

- WWN(World Wide Name)とは FC のノードに対して全世界で一意に割り当てられた番号

## ゾーニング

- FCSW に接続するサーバやストレージを複数のゾーンというグループに分けることができる
- 1 台のスイッチに複数のゾーンを定義する機能のことをゾーニングという
- 異なるゾーンに所属する機器は互いに通信できない
  - ゾーンの定義はポート単位または WWN 単位で行う
  - 1 個のポートを複数のゾーンに所属させることができる

## FSPF(Fabric Shortest Path Fast)

- FCSW のホップ数をコストとして評価し，SPF アルゴリズムに基づいて最小コストを決定する仕組み

## FC-SAN と IP-SAN

- SAN は FC-SAN と IP-SAN に大別される
- FC-SAN は FCSW によって構成されるストレージ共有のためのネットワーク
- IP-SAN は FC フレームまたは SCSI フレームを TCP/IP にカプセル化し，IP ネットワーク上に SAN を構築するもの

## 拡張イーサネット(統合ネットワーク)

- DCB(Data Center Bridging)のこと
- 従来のイーサネットをただ単に高帯域化したものではなく，FC-SAN を伝送することを目的としてイーサネットの機能を拡張し，FC が有していた高信頼性などの優れた特性にできる限り近づけたもの
- 拡張イーサネットでは CNA(Converged Network Adapter)と呼ばれるネットワーク接続アダプタをし用意する

  - これは 1 個のアダプタで HBA と NIC を兼ね備える機能を持つ

- これにより，FC-SAN と IP ネットワークを統合できる
- 拡張イーサネットは FC の FC-0 から FC-1 に置き換わっている
- SCSI はパケットロスを前提としないプロトコルで SCSI の階層が信頼性を担保する必要がある
  - FC はその信頼性を担保している
  - フロー制御など，高信頼性を確保する機能がある
- イーサネットでは FC のような信頼性を担保できないため拡張イーサネットが必要になった
- 拡張イーサネットは FC フレームをカプセル化しているが，フロー制御は拡張イーサネットの方式を使用することが規定されている
- 従来の FC-2 層のクレジット方式のパラメタは使用せず，無視している
- 既存のイーサネットは隣接ノード間でフロー制御を行っているが，これは，自分のバッファが枯渇しそうになったら PAUSE フレームを送り，物理リンクのトラフィックを一時的に止めるように相手に通知する仕組みしかなく，ストレージトラフィックの信頼性を確保するには弱い
- そこで拡張イーサネットは IEEE802.3x の仕様を拡張し，FC-2 層のクレジット方式に変わる新しいフロー制御の方式を規定した
  - 仮想リンクごとの優先度つきバッファ制御(PFC)
    - 1 本の物理リンク上に最大 8 本の仮想リンクを構築し，仮想リンクごとに優先度つきのバッファを持たせる機能を追加した
    - ノードは自分のバッファが枯渇しそうになったら優先度の低い仮想リンクの通信を一時的に止めるように PAUSE フレームを送る仕組みを備えている
    - PFC(Priority Based Flow Control(優先度ベースのフロー制御))
    - この優先度をスイッチが識別するためにパケットの VLAN タグの優先度フィールドを使用する
  - 仮想リンクごとの帯域制御(ETS)
    - 拡張イーサネットは優先度つきバッファ制御に加え仮想リンクごとに帯域制御を行う機能も追加した
    - ETS(Enhanced Transmission Selection,拡張伝送選択)
  - スイッチ間のプロパティ交換(DCBX)
    - かくスイッチが PFC と ETS を装備しても，隣接するスイッチ間で PFC と ETS の設定情報の整合性がとられていないと FC-SAN のクレジットのようなフロー制御ができない
    - 拡張イーサネットは LLDP(Link Layer Discovery Protocol)の機能を利用して拡張イーサネット対応スイッチ間でプロパティ交換を行うことができる
    - これは DCBX(Data Center Bridging Exchange)

## SAN のプロトコル

## FC-SAN

- FC のプロトコルスタックは以下の階層
  - FC-4 層
    - 上位プロトコルとのマッピングを規定する
  - FC-3 層
    - 暗号化機能などを規定する
    - ただし実装している製品は存在しない
  - FC-2 層
    - フロー制御，伝送手順などを規定する
  - FC-1 層
    - 8B/10B と呼ばれる符号化方式，パラレル／シリアル変換を規定する
  - FC-0 層
    - コネクタ，ケーブル，伝送メディアなどの物理的インターフェイスを規定する
- FC-SAN のフロー制御は TCP と似ている

  - 相手が受信できるだけのフレームしか送信しないという点が似ている

- 具体的な FC-SAN のフロー制御は以下のような仕組み

  - 準備
    - 通信を開始する前に隣接するノード間で自分の空きバッファ数を相手に通知しておく
    - 相手側の空きバッファ数のことをクレジットという
    - FC-SAN はクレジットを管理しながらフロー制御を行っている
  - 送信と受信
    - 相手に 1 フレーム送信したら，クレジットを 1 つ減らす
    - 相手から応答がかえってきたらクレジットを 1 つ増やす
  - 連続転送
    - FC-SAN ではクレジットが 0 になるまでは複数のフレームを連続転送することができる
    - クレジットが 0 になったら相手から応答が返ってくるまでフレームを送信しない

- TCP と異なるところは隣接ノード間でバッファの容量を気にしているということ
  - バッファ間の話なので，隣接ノードの局所的なバッファ枯渇に対応できる
  - FC-SAN は通信経路上のあらゆる隣接ノード間でこのバッファ管理に基づくフロー制御を実施している

## IP-SAN

- IP-SAN の通信規格には iSCSI，iFCP，FCIP(Fiber Chanel over IP)がある
- iSCSI は SCSI コマンドを TCP／ IP パケットにカプセル化したり，FC デバイスを用いることなく， IP ネットワークだけで構成できる
- iFCP，FCIP は FC-SAN 通信で用いられる FC フレームを TCP／ IP パケットにカプセルかしている
