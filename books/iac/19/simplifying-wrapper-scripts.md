Simplifying Wrapper Scripts I’ve seen teams spend more time dealing with bugs in their wrapper scripts than on improving their infrastructure code. This situation arises from mixing and coupling concerns that can and should be split apart. Some areas to consider: Split the project life cycle A single script shouldn’t handle tasks during the build, promotion, and apply phases of a project’s life cycle. Write and use different scripts for each of these activities. Make sure you have a clear understanding of where information needs to be passed from one of these phases to the next. Implement clear boundaries between these phases, as with any API or contract. Separate tasks
Break out the various tasks involved in managing your infrastructure, such as assembling configuration values, packaging code, and executing infrastructure tools. Again, define the integration points between these tasks and keep them loosely coupled. Decouple projects A script that orchestrates actions across multiple projects should be separate from scripts that execute tasks within the projects. And it should be possible to execute tasks for any project on its own. Keep wrapper code ignorant Your scripts should not know anything about the projects they support. Avoid hardcoding actions that depend on what the infrastructure code does into your wrapper scripts. Ideal wrapper scripts are generic, usable for any infrastructure project of a particular shape (e.g., any project that uses a particular stack tool). Treating wrapper scripts like “real” code helps with all of this. Test and validate scripts with tools like shellcheck. Apply the rules of good software design to your scripts, such as the rule of composition, single responsibility principle, and designing around domain concepts. See Chapter 15 and the references to other sources of information on good software design.

ラッパースクリプトの単純化 ラッパースクリプトのバグに対処するためにチームが費やす時間を、インフラストラクチャのコードの改善に使うことが多いです。この状況は、分割して管理することができるべき懸念事項を混ぜ合わせてしまっていることから生じています。考慮すべきいくつかの領域: プロジェクトライフサイクルを分割する ビルド、プロモーション、適用の各フェーズでタスクを処理するために単一のスクリプトを使用すべきではありません。これらの活動ごとに異なるスクリプトを作成して使用してください。どのフェーズから次のフェーズに情報を渡す必要があるかを明確に把握してください。API や契約と同様に、これらのフェーズの間に明確な境界を設定してください。 タスクを分離する インフラストラクチャの管理に関わるさまざまなタスクを分離し、構成値の組み立て、コードのパッケージ化、インフラストラクチャツールの実行などの作業を分離してください。また、これらのタスク間の統合ポイントを定義し、それらを緩く連携させるようにしてください。 プロジェクトを分離する 複数のプロジェクトにわたるアクションをオーケストレートするスクリプトは、プロジェクト内でタスクを実行するスクリプトとは別にするべきです。また、任意のプロジェクトに対して単独でタスクを実行できるようにするべきです。 ラッパーコードは知るべきではない ラッパースクリプトは、それらがサポートするプロジェクトについて何も知るべきではありません。インフラストラクチャのコードが行うアクションに依存するハードコードをラッパースクリプトに避けてください。理想的なラッパースクリプトは一般的であり、特定の形状（例：特定のスタックツールを使用するプロジェクト）の任意のインフラストラクチャプロジェクトに使用できるようにするべきです。 これらのすべてに役立つために、ラッパースクリプトを「本物の」コードのように扱ってください。shellcheck などのツールを使用してスクリプトをテストおよび検証してください。組成の原則、シングルレスポンシビリティ原則、ドメインコンセプトを中心に設計するなど、良いソフトウェアデザインの原則をスクリプトに適用してください。詳細は第 15 章と他の情報源の参照を参照してください。

- 考えまとめ
  - これはステージや Job 分割の話？
  - でもインフラコードの改善ってあるしな
  - フェーズごとに異なるスクリプトを書くべきなのはアグリー
  - ラッパーコーデゃ知るべきではない，ってのはなかなかむずそうだけど，良い設計への気づきになりそう
  - ラッパーコードも集中して抽象化すべきってことか
  - この抽象化がうまくいくなら，Dev と Ops とかの分離もうまくいくのかな
  - また社内展開みたいな話もできそう
  - pipeline の社内展開ができたら，セキュリティ，コンプライアンスの適用，遵守に相当貢献するがほんまにできるのか？
