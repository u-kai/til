Prebuilding Servers As discussed earlier (see “Where Things Come From”), there are several sources of content for a new server, including the operating system installation, packages downloaded from repositories, and custom configuration files and application files copied to the server. While you can assemble all of these when you create the server, there are also several ways to prepare server content ahead of time. These approaches can optimize the process of building a server, making it faster and simpler to do, and making it easier to create multiple, consistent servers. What follows are a few approaches to doing this. The section after this then explains options for applying configuration before, during, and after the provisioning process. Hot-Cloning a Server Most infrastructure platforms make it simple to duplicate a running server. Hot-cloning a server in this way is quick and easy, and gives you servers that are consistent at the point of cloning. Cloning a running server can be useful when you want to explore or troubleshoot a server without interfering with its operation. But it carries some risks. One is that a copy of a production server that you make for experimentation might affect production. For example, if a cloned application server is configured to use the production database, you might accidentally pollute or damage production data. Cloned servers running in production usually contain historical data from the original server, such as logfile entries. This data pollution can make troubleshooting
confusing. I’ve seen people spend time puzzling over error messages that turned out not to have come from the server they were debugging. And cloned servers are not genuinely reproducible. Two servers cloned from the same parent at different points in time will be different, and you can’t go back and build a third server and be entirely sure whether and how it is different from any of the others. Cloned servers are a source of configuration drift (see “Configuration Drift”). Using a Server Snapshot Rather than building new servers by directly cloning a running server, you can take a snapshot of a running server and build your servers from that. Again, most infrastructure platforms provide commands and API calls to snapshot servers easily, creating a static image. This way, you can create as many servers as you like, confident that each one is identical to the starting image. Creating a server from a snapshot taken from a live server has many of the other disadvantages of hot-cloning, however. The snapshot may be polluted with logs, configuration, and other data from the original server. It’s more effective to create a clean server image from scratch. Creating a Clean Server Image A server image is a snapshot that you create from clean, known sources so that you can create multiple, consistent server instances. You may do this using the same infrastructure platform features that you would for snapshotting a live server, but the original server instance is never used as a part of your overall systems. Doing this ensures that every new server is clean. A typical process for building a server image is: Create a new server instance from a known source, such as an operating system vendor’s installation image, or an image provided by your infrastructure platform for this purpose. Apply server configuration code or run other scripts on the server. These may install standard packages and agents that you want on all of your servers, harden configuration for security purposes, and apply all of the latest patches.
Snapshot the server, creating an image that you can use as a source for creating multiple server instances. Doing this may involve steps to mark the snapshot as an image for creating new servers. It may also involve tagging and versioning to help manage a library of multiple server images. People sometimes call server images golden images. Although some teams build these images by hand, perhaps following a written checklist of steps, readers of this book immediately see the benefits of automating this process, managing server images as code. Building and delivering server images is the topic of Chapter 13.
サーバープレビルディング
前述のように（「ものはどこから来るのか」を参照）、新しいサーバーのコンテンツは、オペレーティングシステムのインストール、リポジトリからダウンロードしたパッケージ、サーバーにコピーされたカスタム設定ファイルやアプリケーションファイルなど、いくつかのソースから取得できます。これらすべてをサーバーを作成する際に組み立てることができますが、事前にサーバーコンテンツを準備する方法もあります。これらのアプローチは、サーバーの構築プロセスを最適化し、より高速かつ簡単に行い、複数の一貫性のあるサーバーを作成しやすくすることができます。以下には、これを行うためのいくつかのアプローチが示されています。この後のセクションでは、プロビジョニングプロセスの前、中、後での構成適用のオプションについて説明します。

サーバーのホットクローニング
ほとんどのインフラストラクチャプラットフォームは、実行中のサーバーを簡単に複製することができます。このようにサーバーをホットクローニングすると、すばやく簡単に一貫性のあるサーバーが得られます。実行中のサーバーをクローンすることは、その動作に干渉せずにサーバーを調査したりトラブルシューティングしたりする場合に便利です。しかし、いくつかのリスクもあります。1つは、実験のために作成した本番サーバーのコピーが本番環境に影響を与える可能性があるということです。たとえば、クローンされたアプリケーションサーバーが本番データベースを使用するように構成されている場合、本番データを誤って汚染したり破損させたりする可能性があります。本番で実行されているクローンサーバーには、通常、元のサーバーの履歴データ（ログファイルのエントリなど）が含まれています。このデータの汚染は、トラブルシューティングを混乱させる可能性があります。私は、デバッグしているサーバーから発生したエラーメッセージではないことが判明したエラーメッセージについて、人々が時間を費やして解決策を見つける姿を見たことがあります。また、クローンサーバーは本当に再現可能ではありません。同じ親から異なる時点でクローンされた2つのサーバーは異なるものであり、第3のサーバーをビルドしてもそれがどのサーバーとどのように異なるかを完全に確認することはできません。クローンサーバーは構成のドリフトの原因となります（「構成のドリフト」を参照）。

サーバースナップショットの使用
実行中のサーバーを直接クローンして新しいサーバーを構築する代わりに、実行中のサーバーのスナップショットを取得し、それを基にサーバーを構築することができます。同様に、ほとんどのインフラストラクチャプラットフォームは、サーバーを簡単にスナップショットするためのコマンドやAPI呼び出しを提供しており、静的なイメージを作成することができます。この方法で、同じイメージとなるサーバーを必要な数だけ作成することができます。ただし、実行中のサーバーからのスナップショットを使用してサーバーを作成する場合、ホットクローニングと同様の欠点があります。スナップショットには、オリジナルサーバーからのログ、構成、その他のデータが混入する可能性があります。したがって、ゼロからクリーンなサーバーイメージを作成する方が効果的です。

クリーンなサーバーイメージの作成
サーバーイメージは、クリーンで明確なソースから作成したスナップショットであり、複数の一貫性のあるサーバーインスタンスを作成するために使用します。これは、ライブサーバーのスナップショットを作成するために使用するものと同じインフラストラクチャプラットフォームの機能を使用して行うことができますが、元のサーバーインスタンスは全体のシステムの一部として使用されることはありません。これにより、すべての新しいサーバーがクリーンな状態であることが保証されます。サーバーイメージを構築する典型的なプロセスは次のとおりです。既知のソースから新しいサーバーインスタンスを作成します。これは、オペレーティングシステムベンダーのインストールイメージや、インフラストラクチャプラットフォームが提供するこの目的のためのイメージなどです。サーバーに設定コードを適用したり、他のスクリプトを実行したりします。これには、すべてのサーバーで必要な標準パッケージやエージェントのインストール、セキュリティ目的の構成の強化、最新のパッチの適用などが含まれる場合があります。
サーバーのスナップショットを作成し、複数のサーバーインスタンスのソースとして使用できるイメージを作成します。これには、スナップショットを新しいサーバーの作成用のイメージとしてマークするための手順や、ライブラリの複数のサーバーイメージを管理するためのタグ付けやバージョン管理が含まれる場合があります。人々は、サーバーイメージを"ゴールデンイメージ"と呼ぶことがあります。一部のチームはこれらのイメージを手作業で作成するかもしれませんが、この本の読者は、このプロセスを自動化し、サーバーイメージをコードとして管理することの利点をすぐに理解できます。サーバーイメージの構築と配信は、第13章のテーマです。