Configuration Drift Configuration drift is variation that happens over time across systems that were once identical. Figure 2-1 shows this. Manually making changes can cause configuration drift. It can also happen if you use automation tools to make ad hoc changes to only some of the instances. Configuration drift makes it harder to maintain consistent automation.
As an example of how infrastructure can diverge over time, consider the journey of our example team, ShopSpinner.5 ShopSpinner runs a separate instance of its application for each store, with each instance configured to use custom branding and product catalog content. In the early days, the ShopSpinner team ran scripts to create a new application server for each new store. The team managed the infrastructure manually or by writing scripts and tweaking them each time it needed to make a change. One of the customers, Water Works,6 has far more traffic to its order management application than the others, so the team tweaked the configuration for the Water Works server. The team didn’t make the changes to the other customers, because it was busy and it didn’t seem necessary. Later, the ShopSpinner team adopted Servermaker to automate its application server configuration.7 The team first tested it with the server for Palace Pens,8 a lower-volume customer, and then rolled it out to the other customers.
Unfortunately, the code didn’t include the performance optimizations for Water Works, so it stripped those improvements. The Water Works server slowed to a crawl until the team caught and fixed the mistake. The ShopSpinner team overcame this by parameterizing its Servermaker code. It can now set resource levels different for each customer. This way, the team can still apply the same code across every customer, while still optimizing it for each. Chapter 7 describes some patterns and antipatterns for parameterizing infrastructure code for different instances.
The automation fear spiral describes how many teams fall into configuration drift and technical debt. At an Open Space session on configuration automation at a DevOpsDays conference, I asked the group how many of them were using automation tools like Ansible, Chef, or Puppet. The majority of hands went up. I asked how many were running these tools unattended, on an automatic schedule. Most of the hands went down. Many people have the same problem I had in my early days of using automation tools. I used automation selectively — for example, to help build new servers, or to make a specific configuration change. I tweaked the configuration each time I ran it to suit the particular task I was doing. I was afraid to turn my back on my automation tools because I lacked confidence in what they would do. I lacked confidence in my automation because my servers were not consistent. My servers were not consistent because I wasn’t running automation frequently and consistently. This is the automation fear spiral, as shown in Figure 2-2. Infrastructure teams must break this spiral to use automation successfully. The most effective way to break the spiral is to face your fears. Start with one set of servers. Make sure you can apply, and then reapply, your infrastructure code to these servers. Then schedule an hourly process that continuously applies the code to those servers. Then pick another set of servers and repeat the process. Do this until every server is continuously updated. Good monitoring and automated testing builds the confidence to continuously synchronize your code. This exposes configuration drift as it happens, so you can fix it immediately.
設定ドリフト
設定ドリフトは、かつて同一であったシステム間で時間の経過とともに生じる変動です。図2-1に示されています。手動で変更を行うと、設定のドリフトが生じることがあります。また、いくつかのインスタンスに対して臨時の変更を行うために自動化ツールを使用する場合にも起こりえます。設定のドリフトは、一貫した自動化を維持することを難しくします。

インフラストラクチャが時間とともに乖離する例として、例のチームであるショップスピナーの旅を考えてみましょう。ショップスピナーは、各店舗ごとに独自のアプリケーションインスタンスを実行し、各インスタンスはカスタムのブランディングと製品カタログコンテンツを使用するように設定されています。初期の頃、ショップスピナーチームは、新しい店舗ごとに新しいアプリケーションサーバーを作成するスクリプトを実行しました。チームは、インフラストラクチャを手動で管理するか、スクリプトを書いて必要な変更を行うたびに微調整しました。お客様の1つであるウォーターワークスは他のお客様よりも注文管理アプリケーションへのトラフィックがはるかに多いため、チームはウォーターワークスサーバーの設定を調整しました。チームは他のお客様に変更を加えませんでした。忙しかったからですし、必要性も感じられなかったからです。後に、ショップスピナーチームはServermakerを採用し、アプリケーションサーバーの設定を自動化しました。最初に低トラフィックの顧客であるパレスペンズのサーバーでテストし、その後他の顧客に展開しました。

残念なことに、コードにはウォーターワークス向けのパフォーマンス最適化が含まれておらず、それらの改善が削除されました。ウォーターワークスサーバーは停滞し、チームが誤りに気付いて修正するまで動きませんでした。ショップスピナーチームは、Servermakerコードをパラメータ化することでこれを乗り越えました。これにより、各顧客に対してリソースレベルを異ならせることができます。このように、チームは同じコードをすべての顧客に適用することができますが、それぞれに最適化することも可能です。第7章では、異なるインスタンスに対してインフラストラクチャコードをパラメータ化するためのいくつかのパターンとアンチパターンについて説明しています。

自動化の恐怖スパイラルは、多くのチームが設定のドリフトと技術的な負債に陥る方法を説明しています。DevOpsDaysカンファレンスの設定自動化に関するOpen Spaceセッションで、私はAnsible、Chef、またはPuppetなどの自動化ツールを使用しているか尋ねました。その多くが手を挙げました。その後、これらのツールを自動スケジュールで無人運転しているか尋ねました。ほとんどの手が下がりました。私は、初めて自動化ツールを使用したときに私自身が同じ問題を抱えていたことを多くの人が共有していると気付きました。私は自動化を選択的に使用しました。新しいサーバーの構築をサポートするためや特定の設定変更を行うために使用しました。実行するたびに設定を微調整し、特定のタスクに合わせました。私は自動化ツールを信頼できなかったため、それを背に向けることを恐れていました。サーバーが一貫していなかったため、私の自動化に自信がありませんでした。サーバーが一貫していなかったのは、自動化を頻繁かつ一貫して実行していなかったためです。これが図2-2に示されている自動化の恐怖スパイラルです。インフラストラクチャチームはこのスパイラルを断ち切って自動化を成功させる必要があります。スパイラルを断ち切る最も効果的な方法は、恐れに立ち向かうことです。一つのサーバーセットから始めてください。インフラストラクチャコードをこれらのサーバーに適用し、再適用して適用できることを確認してください。その後、コードをこれらのサーバーに連続的に適用する毎時のプロセスをスケジュールしてください。次に、別のサーバーセットを選択してプロセスを繰り返します。すべてのサーバーが連続的に更新されるまでこれを繰り返してください。適切なモニタリングと自動化テストにより、コードを連続的に同期する自信を築き上げることができます。これにより、設定のドリフトが発生するとすぐにそれを修正することができます。