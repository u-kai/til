Configuration Registry Larger organizations with many teams working across larger systems with many moving parts often find a configuration registry useful. It can be useful for configuring stacks instances, as I described in “Pattern: Stack Parameter Registry”. It can also be useful for managing integration dependencies across different stack instances, applications, and other services, as I’ll explain in “Discovering Dependencies Across Stacks”. A registry can provide a useful source of information about the composition and state of your infrastructure. You can use this to create tools, dashboards, and reports, as well as for monitoring and auditing your systems. So it’s worth digging into how to implement and use a configuration registry. Implementing a Configuration Registry There are different ways to build a configuration registry. You can use a registry provided out of the box by your infrastructure automation tool, or you can run a general-purpose registry
product. Most cloud providers also have configuration registry services that you can use. If you are brave, you can hand-roll a practical registry using fairly basic pieces. Infrastructure automation tool registries Many infrastructure automation toolchains include a configuration registry service. These tend to be part of a centralized service that may also include features such as source code management, monitoring, dashboards, and command orchestration. Examples of these include: Chef Infra Server PuppetDB Ansible Tower Salt Mine You may be able to use these services with tools outside the toolchain that provides them. Most can expose values, so you could write a script that discovers information about the current state of infrastructure managed by the configuration tool. Some infrastructure tool registries are extensible, so you can use them to store the data from other tools. However, this creates a dependency on whatever toolchain provides the registry service. The service may not fully support integration with third-party tools. It might not offer a contract or API that guarantees future compatibility. So if you’re considering using an infrastructure tool’s data store as a general-purpose configuration registry, consider how well it supports this use case, and what kind of lock-in it creates. General-purpose configuration registry products There are many dedicated configuration registry and key-value store database products available outside the toolchains of a particular automation tool. Some examples include: Zookeeper etcd Consul2
These are generally compatible with different tools, languages, and systems, so avoid locking you into any particular toolchain. However, it can take a fair bit of work to define how data should be stored. Should keys be structured like environment/service/application, service/application/environment, or something else entirely? You may need to write and maintain custom code to integrate different systems with your registry. And a configuration registry gives your team yet another thing to deploy and run. Platform registry services Most cloud platforms provide a key-value store service, such as the AWS SSM Parameter Store. These give you most of the advantages of a general-purpose configuration registry product, without forcing you to install and support it yourself. However, it does tie you to that cloud provider. In some cases, you may find yourself using a registry service on one cloud to manage infrastructure running on another! DIY configuration registries Rather than running a configuration registry server, some teams build a custom lightweight configuration registry by storing configuration files in a central location, or by using distributed storage. They typically use an existing file storage service like an object store (e.g., an S3 bucket on AWS), a version control system, networked filesystem, or even a web server. A variation of this is packaging configuration settings into system packages, such as a .deb or .rpm file (for Debian-based or Rad Hat-Based Linux distributions, respectively), and pushing them to an internal APT or YUM repository. You can then download configuration files to local servers using the standard package management tool. Another variation is using a standard relational or document store database server. All of these approaches leverage existing services, so they can be quick to implement for a simple project rather than needing to install and run a new server. But when you get beyond trivial situations, you may find yourself building and maintaining the functionality that you could get off the shelf. Single or Multiple Configuration Registries Combining all configuration values from across all of your systems, services, and tools is an appealing idea. You could keep everything in one place rather than sprawling across many different systems. “One registry to rule them all.” However, this isn’t always practical in larger, more heterogeneous environments. Many tools, such as monitoring services and server configuration systems, have their own registry. You’ll often find different registry and directory products that are very good at specific tasks, such as license management, service discovery, and user directories. Bending all of these tools to use a single system creates an ongoing flow of work. Every update to every tool needs evaluation, testing, and potentially more work to maintain the integration. It may be better to pull relevant data from across the services where they are stored. Make sure you know which system is the source of truth for any particular data or configuration item. Design your systems and tools with this understanding. Some teams use messaging systems to share configuration data as events. Whenever a system changes a configuration value, it sends an event. Other systems can monitor the event queue for changes to configuration items in which they are interested.
設定レジストリ 多くのチームが大規模なシステムで作業している大規模な組織は、移動の多い多くのパーツを持つシステムで動作する設定レジストリが便利とされます。「パターン：スタックパラメータレジストリ」で説明したように、スタックのインスタンスを設定するために役立つ場合もあります。また、「スタック間の依存関係の発見」で説明するように、異なるスタックのインスタンス、アプリケーション、および他のサービスの統合依存関係を管理するのにも便利です。レジストリは、インフラストラクチャの構成と状態に関する有用な情報源を提供する場合があります。これを使用してツール、ダッシュボード、レポートを作成することができます。また、システムの監視と監査にも使用できます。そのため、設定レジストリを実装して使用する方法について詳しく調査する価値があります。 設定レジストリの実装 設定レジストリを構築するためのさまざまな方法があります。インフラストラクチャの自動化ツールが提供するレジストリを使用するか、汎用のレジストリ製品を実行することができます。多くのクラウドプロバイダも使用できる設定レジストリのサービスを提供しています。勇気を持っていれば、比較的基本的な部品を使用して実用的なレジストリを手作りすることもできます。 インフラストラクチャの自動化ツールのレジストリ 多くのインフラストラクチャの自動化ツールチェーンには、設定レジストリサービスが含まれています。これらは一般に、ソースコード管理、モニタリング、ダッシュボード、コマンドオーケストレーションなどの機能も含まれる集中型サービスの一部です。これには、次のようなものがあります。 ・Chef Infra Server ・PuppetDB ・Ansible Tower ・Salt Mine これらのサービスは、それらを提供するツールチェーンの外部のツールと一緒に使用することができる場合があります。ほとんどの場合、値を公開できるので、設定ツールによって管理されるインフラストラクチャの現在の状態に関する情報を検出するスクリプトを書くことができます。一部のインフラストラクチャツールのレジストリは拡張可能なため、他のツールからのデータを保存するために使用することができます。ただし、これにより、レジストリサービスを提供するツールチェーンに依存する状態が作成されます。このサービスは、サードパーティのツールとの統合を完全にサポートしていない場合があります。将来の互換性を保証する契約またはAPIを提供していないかもしれません。そのため、インフラストラクチャツールのデータストアを汎用の設定レジストリとして使用することを検討する場合は、このユースケースをどれだけサポートしているか、どのようなロックインを作成するかを考慮してください。 汎用の設定レジストリ製品 特定の自動化ツールチェーンのツール群の外部にも、専用の設定レジストリとキーバリューストアデータベース製品が多数あります。いくつかの例としては、Zookeeper、etcd、Consulなどがあります。これらは一般的にさまざまなツール、言語、システムと互換性があり、特定のツールチェーンにロックインされることを避けることができます。ただし、データの保存方法を定義するためにはかなりの作業が必要となる場合があります。キーは環境/サービス/アプリケーション、サービス/アプリケーション/環境、または完全に異なる形式で構造化すべきですか？さまざまなシステムをレジストリと統合するためにカスタムコードを書いてメンテナンスする必要があるかもしれません。また、設定レジストリはチームにとって展開と実行する必要があるもう一つの要素となります。 プラットフォームレジストリサービス 多くのクラウドプラットフォームは、AWS SSMパラメータストアなどのキーバリューストアサービスを提供しています。これにより、自分でインストールやサポートする必要がない汎用の設定レジストリ製品の利点のほとんどを享受することができます。ただし、これにより特定のクラウドプロバイダに依存することになります。場合によっては、別のクラウド上で実行されているインフラストラクチャを管理するために、別のクラウド上のレジストリサービスを使用することがあります！ DIY設定レジストリ チームによっては、設定ファイルを中央の場所に保存するか、分散ストレージを使用してカスタムの軽量設定レジストリを構築する場合があります。通常、AWSのS3バケットなどのオブジェクトストア、バージョン管理システム、ネットワークファイルシステム、またはWebサーバーなど、既存のファイルストレージサービスを使用します。このバリエーションの一つは、設定設定をシステムパッケージ（たとえばDebianベースまたはRad HatベースのLinuxディストリビューション用の.debまたは.rpmファイル）にパッケージ化し、内部のAPTまたはYUMリポジトリにプッシュすることです。その後、標準のパッケージ管理ツールを使用してローカルサーバーに設定ファイルをダウンロードできます。 別のバリエーションは、標準のリレーショナルデータベースまたはドキュメントストアデータベースサーバーを使用することです。これらのアプローチはすでに存在するサービスを活用しているため、新しいサーバーをインストールして実行する必要がないため、単純なプロジェクトの実装には迅速です。ただし、単純な状況を超えると、オフシェルフで取得できる機能を構築およびメンテナンスする必要がある場合があります。 単一または複数の設定レジストリ システム、サービス、ツール全体の設定値を組み合わせるという考えは魅力的です。多くの異なるシステムに広がるのではなく、すべてを1つの場所に保持できます。「すべてを支配するための1つのレジストリ」です。ただし、これはより大規模で異種な環境では常に実用的ではありません。モニタリングサービスやサーバー設定システムなど、多くのツールには独自のレジストリがあります。ライセンス管理、サービスの検出、ユーザーディレクトリなど、特定のタスクに非常に適したさまざまなレジストリとディレクトリ製品もよく見つかります。これらのツールをすべて1つのシステムで使用するように屈曲させると、継続的な作業が発生します。すべてのツールのすべての更新には、評価、テスト、および統合の保守作業が必要となる場合があります。データまたは設定項目がどのシステムが真実のソースであるかを正確に把握しておくことが重要です。この理解をもとに、システムとツールを設計してください。一部のチームは、イベントとして設定データを共有するためにメッセージングシステムを使用しています。システムが設定値を変更するたびに、イベントを送信します。他のシステムは、関心のある設定項目の変更をイベントキューで監視することができます。