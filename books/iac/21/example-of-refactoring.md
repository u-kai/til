Example of Refactoring The ShopSpinner team decides to decompose its current stack into multiple stacks and stack instances. Its planned implementation includes one stack instance for the container cluster that hosts its web servers and another for shared networking structures. The team will also have a pair of stacks for each service, one for the application server and its associated networking, and one for the database instance for that service (see Figure 21-4).
The team members also want to replace their container cluster product, moving from a Kubernetes cluster that they deploy themselves onto virtual machines to use Containers as a Service provided by their cloud vendor (see “Application Cluster Solutions”). The team decides to incrementally implement its decomposed architecture. The first step is to extract the container cluster into its own stack, and then replace the container product within the stack (Figure 21-5).
This plan is an example of using refactoring to enable a change. Changing the container cluster solution will be easier when it is isolated into its own stack than when it’s a part of a larger stack with other infrastructure. When the team members extract the cluster into its own stack, they can define its integration points for the rest of the system. They can write tests and other validations that keep the separation and integration clean. Doing this gives the team confidence that they can safely change the contents of the cluster stack.
Building New Rather than incrementally changing your existing production system, you could build the new version of your system separately and swap users over when you’re finished. Building the new version may be easier if you’re drastically changing your system design and implementation. Even so, it’s useful to get your work into production as quickly as possible. Extracting and rebuilding one part of your system at a time is less risky than rebuilding everything at once. It also tests and delivers the value of improvements more quickly. So even a substantial rebuild can be done incrementally.
リファクタリングの例 ショップスピナーチームは、現在のスタックを複数のスタックおよびスタックインスタンスに分解することを決定しました。予定されている実装には、Webサーバをホストするコンテナクラスタ用の1つのスタックインスタンスと、共有ネットワーキング構造用のもう1つのスタックが含まれます。チームはまた、各サービスごとに一対のスタックを持つ予定であり、アプリケーションサーバと関連するネットワーキング用の1つと、そのサービスのデータベースインスタンス用のもう1つがあります（図21-4を参照）。
チームのメンバーはまた、仮想マシンに展開する自前のKubernetesクラスタから、クラウドベンダーが提供するContainers as a Serviceを使用するために、コンテナクラスタ製品を置き換えたいと考えています（「アプリケーションクラスタのソリューション」を参照）。チームは、分解されたアーキテクチャを段階的に実装することを決定します。最初のステップは、コンテナクラスタを独自のスタックに抽出し、そのスタック内のコンテナ製品を置き換えることです（図21-5を参照）。
この計画は、変更を可能にするためにリファクタリングを使用する例です。コンテナクラスタソリューションを変更することは、他のインフラストラクチャが含まれる大きなスタックの一部ではなく、独自のスタックに分離されている場合の方が簡単です。チームメンバーがクラスタを独自のスタックに抽出すると、システムの残りの部分との統合ポイントを定義することができます。分離と統合をクリーンに保つテストや他の検証を書くことができます。これにより、チームはクラスタスタックの内容を安全に変更できる自信を持つことができます。
新しいビルド 既存のプロダクションシステムを徐々に変更する代わりに、新しいバージョンのシステムを別々に構築し、完成したらユーザーを切り替えることができます。システムの設計と実装を大幅に変更する場合、新しいバージョンの構築は容易になる場合があります。それでも、作業をできるだけ早く本番環境に展開することは有用です。システムの一部を抽出して再構築する方が、一度にすべてを再構築するよりもリスクが少なくなります。また、改善の価値を早くテストし提供することもできます。したがって、大規模な再構築も段階的に行うことができます。