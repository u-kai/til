Offline Image Building Process The process of booting a server instance, applying the configuration, and then shutting the instance down to create the server image can be slow. An alternative is to use a source image that is mountable as a disk volume — for example, an EBS-backed AMI in AWS. You can mount a copy of this image as a disk volume, and then configure the files on that disk image, as shown in Figure 13-3. Once you have finished configuring the disk image, you can unmount it and convert it to the platform’s server image format.
To build an image on a disk volume, you need to mount the volume on the compute instance where your image building tool runs. For example, if you build images using a pipeline as described later in this chapter, this could be a CD tool agent. Another requirement is a tool or scripts that can properly configure the disk volume. This can be tricky. Server configuration tools apply configuration code to the server instance on which they are running. Even if you write simpler scripts, like a shell script, those scripts often run a tool like a package installer, which defaults to installing files in the running server’s filesystem: yum install java Many tools have command-line or configuration options that you can set to install files to a different path. You can use this to install packages to a different path (for example, yum install java --prefix /mnt/image_builder/):
yum install --prefix /mnt/image_builder/ java However, this is tricky and easy to get wrong. And not all tools support an option like this one. Another approach is to use the chroot command, which runs a command with a different filesystem root directory: chroot /mnt/image_builder/ yum install java The advantage of using the chroot command is that it works for any tool or command. Popular image building tools like Packer support chroot out of the box.4
オフラインのイメージビルドプロセス
サーバーインスタンスを起動し、設定を適用し、それからインスタンスをシャットダウンしてサーバーイメージを作成するプロセスは遅いことがあります。別の方法として、ディスクボリュームとしてマウント可能なソースイメージを使用することが挙げられます。例えば、AWSのEBSバックドAMIです。このイメージのコピーをディスクボリュームとしてマウントし、そのディスクイメージ上のファイルを設定することができます（図13-3参照）。ディスクイメージの設定が完了したら、アンマウントしてプラットフォームのサーバーイメージ形式に変換することができます。

ディスクボリューム上にイメージを構築するためには、イメージビルドツールを実行する計算インスタンスにボリュームをマウントする必要があります。例えば、この章の後で説明するパイプラインを使用してイメージを構築する場合、これはCDツールエージェントになるかもしれません。もう一つの要件は、ディスクボリュームを適切に設定するツールやスクリプトです。これは難しい場合があります。サーバーの設定ツールは、実行しているサーバーインスタンスに設定コードを適用します。シェルスクリプトなどの単純なスクリプトでも、しばしばyum install javaのようなパッケージインストーラーのようなツールを実行します。この場合、ツールには異なるパスにファイルをインストールするために設定できるコマンドラインオプションやコンフィグレーションオプションが多く存在します。これを利用してパッケージを異なるパスにインストールすることができます（例えば、yum install --prefix /mnt/image_builder/ java）。

しかしこれは難しくて簡単に間違えることもあります。また、このようなオプションをサポートしていないツールもあります。もう一つのアプローチは、chrootコマンドを使用する方法で、別のファイルシステムルートディレクトリでコマンドを実行します（chroot /mnt/image_builder/ yum install java）。chrootコマンドを使用する利点は、どんなツールやコマンドでも動作することです。Packerなどの人気のあるイメージビルドツールはデフォルトでchrootをサポートしています。