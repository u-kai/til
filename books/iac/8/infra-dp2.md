Platform Elements Needed for a Stage Platform services are a particular type of dependency for your system. Your system may ultimately run on your infrastructure platform, but you may be able to usefully run and test parts of it offline. For example, code that defines networking structures needs to provision those structures on the cloud platform for meaningful tests. But you may be able to test code that installs an application server package in a local virtual machine, or even in a container, rather than needing to stand up a virtual machine on your cloud platform. So earlier test stages may be able to run without using the full cloud platform for some components (see Figure 8-8). Figure 8-8. Progressive use of platform elements Delivery Pipeline Software and Services You need software or a hosted service to build a pipeline. A pipeline system needs to do a few things: Give you a way to configure the pipeline stages.
Trigger stages from different actions, including automated events and manual triggers. The tool should support more complex relationships such as fanning in (one stage with multiple input stages) and fanning out (one stage with multiple output stages). Support any actions you may need for your stages, including applying infrastructure code and running tests. You should be able to create custom activities rather than having a fixed set of supported ones. Handle artifacts and other outputs of stages, including being able to pass them from one stage to the next. Help you trace and correlate specific versions and instances of code, artifacts, outputs, and infrastructure. There are a few options for a pipeline system: Build server Many teams use a build server such as Jenkins, Team City, Bamboo, or GitHub Actions to create pipelines. These are often “job-oriented” rather than “stream-oriented.” The core design doesn’t inherently correlate versions of code, artifacts, and runs across multiple jobs. Most of these products have added support for pipelines as an overlay in their UI and configuration. CD software CD software is built around the pipeline concept. You define each stage as part of a pipeline, and code versions and artifacts are associated with the pipeline so you can trace them forward and backward. CD tools include GoCD,14 ConcourseCI,15 and BuildKite. SaaS services Hosted CI and CD services include CircleCI, TravisCI, AppVeyor, Drone, and BoxFuse. Cloud platform services Most cloud vendors include CI and CD services, including AWS CodeBuild (CI) and AWS CodePipeline (CD), and Azure Pipelines. Source code repository services
Many source code repository products and vendors have added CI support that you can use to create pipelines. Two prominent examples are GitHub Actions, and GitLab CI and CD. The products I mentioned here were all designed with application software in mind. You can use most of them to build pipelines for infrastructure, although they may need extra work. A few products and services designed for Infrastructure as Code are emerging as I write. This is a rapidly changing area, so I suspect that what I have to say about these tools will be out of date by the time you read this, and missing newer tools. But it’s worth looking at what exists now, to give context for evaluating tools as they emerge and evolve: Atlantis is a product that helps you to manage pull requests for Terraform projects, and to run plan and apply for a single instance. It doesn’t run tests, but you can use it to create a limited pipeline that handles code reviews and approvals for infrastructure changes. Terraform Cloud is evolving rapidly. It is Terraform-specific, and it includes more features (such as a module registry) than CI and pipelines. You can use Terraform cloud to create a limited pipeline that plans and applies a project’s code to multiple environments. But it doesn’t run tests other than policy validations with HashiCorp’s own Sentinel product. WeaveWorks makes products and services for managing Kubernetes clusters. These include tools for managing the delivery of changes to cluster configuration as well as applications using pipelines based around Git branches, an approach it calls GitOps. Even if you don’t use WeaveWorks’s tools, it’s an emerging model that’s worth watching. I’ll touch on it a bit more in “GitOps”.
ステージ用のプラットフォーム要素 プラットフォームサービスは、システムの特定の依存性の一部です。システムは最終的にはインフラストラクチャプラットフォーム上で実行されますが、オフラインで一部の実行とテストができる場合もあります。たとえば、ネットワーキング構造を定義するコードは、有意義なテストのためにクラウドプラットフォーム上でこれらの構造をプロビジョニングする必要があります。しかし、アプリケーションサーバーパッケージをローカル仮想マシンやコンテナにインストールするコードは、クラウドプラットフォーム上の仮想マシンを立ち上げる必要なくテストできる場合もあります。つまり、以前のテスト段階では一部のコンポーネントに対して完全なクラウドプラットフォームを使用せずに実行できる場合があります（図8-8を参照）。図8-8。プラットフォーム要素の段階的な使用  デリバリーパイプラインのソフトウェアとサービス パイプラインを構築するためのソフトウェアまたはホストされたサービスが必要です。パイプラインシステムは次のことを行う必要があります。 パイプラインステージを設定する方法を提供します。 さまざまなアクションからステージをトリガーします。これには自動イベントや手動トリガーなどが含まれます。ツールは、複雑な関係もサポートする必要があります。たとえば、複数の入力ステージを持つステージを制御する「ファンイン」と、複数の出力ステージを持つステージを制御する「ファンアウト」などです。 インフラストラクチャコードの適用やテストの実行など、ステージに必要なアクションをサポートします。サポートされているアクションの固定セットではなく、カスタムアクティビティを作成できるようにするべきです。 ステージのアーティファクトや他の出力を処理し、次のステージに渡すことができるようにします。 コード、アーティファクト、出力、およびインフラストラクチャの特定のバージョンとインスタンスを追跡および関連付けるのに役立ちます。 パイプラインシステムのオプションはいくつかあります。 ビルドサーバー ビルドサーバー（Jenkins、Team City、Bamboo、GitHub Actionsなど）を使用してパイプラインを作成するチームも多数あります。これらは通常「ジョブ指向」であり、「ストリーム指向」ではありません。基本的な設計では、コードのバージョン、アーティファクト、および作業が複数のジョブをまたいで関連付けられません。これらの製品のほとんどは、UIと構成のオーバーレイとしてパイプラインのサポートを追加しています。 CDソフトウェア CDソフトウェアは、パイプラインのコンセプトを中心に構築されています。各ステージをパイプラインの一部として定義し、コードのバージョンとアーティファクトがパイプラインに関連付けられているため、それらを前後に追跡できます。 CDツールには、GoCD、ConcourseCI、BuildKiteなどがあります。 SaaSサービス ホストされたCIとCDサービスには、CircleCI、TravisCI、AppVeyor、Drone、BoxFuseなどがあります。 クラウドプラットフォームサービス 多くのクラウドベンダーは、AWS CodeBuild（CI）、AWS CodePipeline（CD）、Azure Pipelinesなどを含むCIとCDサービスを提供しています。 ソースコードリポジトリサービス
多くのソースコードリポジトリ製品やベンダーは、パイプラインを作成するために使用できるCIのサポートを追加しています。代表的な例としては、GitHub ActionsやGitLab CI and CDがあります。ここで紹介した製品はすべてアプリケーションソフトウェアを念頭に設計されています。それらのほとんどはインフラストラクチャのパイプラインを構築するためにも使用できますが、追加の作業が必要な場合もあります。私が書き込んでいる間に、インフラストラクチャとしてのコードに特化したいくつかの製品やサービスが出現しています。この分野は急速に変化しているため、私がこれらのツールについて言及する情報は、読者が読む時点で既に古くなっている可能性があり、より新しいツールが抜けているかもしれません。しかし、今存在するものを見て、新たに出現し進化するツールを評価するための文脈を提供する価値はあります。 Atlantisは、Terraformプロジェクトのプルリクエストを管理し、単一のインスタンスに対してプランや適用を実行するのに役立つ製品です。テストは実行しませんが、インフラストラクチャの変更に対するコードレビューや承認を処理する限定されたパイプラインを作成するために使用できます。 Terraform Cloudは急速に進化しています。Terraform固有の機能（モジュールレジストリなど）が含まれており、CIやパイプラインよりも多機能です。Terraform Cloudを使用して、プロジェクトのコードを複数の環境に計画および適用する限定されたパイプラインを作成できます。ただし、HashiCorp独自のSentinel製品でポリシーの検証以外のテストは実行されません。 WeaveWorksは、Kubernetesクラスタを管理するための製品やサービスを提供しています。これには、Gitブランチを基盤としたパイプラインを使用してクラスタ構成およびアプリケーションの変更の配信を管理するツールが含まれます。WeaveWorksのツールを使用しない場合でも、値する注目のあるモデルです。後ほど「GitOps」で少し詳しく説明します。