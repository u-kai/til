Testing in Production Testing releases and changes before applying them to production is a big focus in our industry. At one client, I counted eight groups that needed to review and approve releases, even apart from the various technical teams who had to carry out tasks to install and configure various parts of the system.16
As systems increase in complexity and scale, the scope of risks that you can practically check for outside of production shrinks. This isn’t to say that there is no value in testing changes before applying them to production. But believing that prerelease testing can comprehensively cover your risks leads to: Over-investing in prerelease testing, well past the point of diminishing returns Under-investing in testing in your production environment Going Deeper on Testing in Production For more on testing in production, I recommend watching Charity Majors’ talk, “Yes, I Test in Production (And So Should You)”, which is a key source of my thinking on this topic. What You Can’t Replicate Outside Production There are several characteristics of production environments that you can’t realistically replicate outside of production: Data Your production system may have larger data sets than you can replicate, and will undoubtedly have unexpected data values and combinations, thanks to your users. Users Due to their sheer numbers, your users are far more creative at doing strange things than your testing staff. Traffic If your system has a nontrivial level of traffic, you can’t replicate the number and types of activities it will regularly experience. A week-long soak test is trivial compared to a year of running in production. Concurrency Testing tools can emulate multiple users using the system at the same time, but they can’t replicate the unusual combinations of things that your users do concurrently.
The two challenges that come from these characteristics are that they create risks that you can’t predict, and they create conditions that you can’t replicate well enough to test anywhere other than production. By running tests in production, you take advantage of the conditions that exist there — large natural data sets and unpredictable concurrent activity. Why Test Anywhere Other Than Production? Obviously, testing in production is not a substitute for testing changes before you apply them to production. It helps to be clear on what you realistically can (and should!) test beforehand: Does it work? Does my code run? Does it fail in ways I can predict? Does it fail in the ways it has failed before? Testing changes before production addresses the known unknowns, the things that you know might go wrong. Testing changes in production addresses the unknown unknowns, the more unpredictable risks. Managing the Risks of Testing in Production Testing in production creates new risks. There are a few things that help manage these risks: Monitoring Effective monitoring gives confidence that you can detect problems caused by your tests so you can stop them quickly. This includes detecting when tests are causing issues so you can stop them quickly. Observability Observability gives you visibility into what’s happening within the system at a level of detail that helps you to investigate and fix problems quickly, as well as improving the quality of what you can test.17 Zero-downtime deployment
Being able to deploy and roll back changes quickly and seamlessly helps mitigate the risk of errors (see “Changing Live Infrastructure”). Progressive deployment If you can run different versions of components concurrently, or have different configurations for different sets of users, you can test changes in production conditions before exposing them to users (see “Changing Live Infrastructure”). Data management Your production tests shouldn’t make inappropriate changes to data or expose sensitive data. You can maintain test data records, such as users and credit card numbers, that won’t trigger real-world actions. Chaos engineering Lower risk in production environments by deliberately injecting known types of failures to prove that your mitigation systems work correctly (see “Chaos Engineering”). Monitoring as Testing Monitoring can be seen as passive testing in production. It’s not true testing, in that you aren’t taking an action and checking the result. Instead, you’re observing the natural activity of your users and watching for undesirable outcomes. Monitoring should form a part of the testing strategy, because it is a part of the mix of things you do to manage risks to your system. Conclusion This chapter has discussed general challenges and approaches for testing infrastructure. I’ve avoided going very deeply into the subjects of testing, quality, and risk management. If these aren’t areas you have much experience with, this chapter may give you enough to get started. I encourage you to read more, as testing and QA are fundamental to Infrastructure as Code.
本文は、本番環境でのテストに焦点を当てています。本番環境へのリリースや変更を適用する前に、テストを行うことが業界で重要視されています。ある顧客では、リリースのレビューと承認を行う必要があるグループが8つありました。システムの複雑さと規模が増すにつれて、本番環境以外で実際に確認できるリスクの範囲は縮小していきます。ですが、リリース前のテストでリスクを網羅的にカバーできると思い込むことは、以下のような問題を引き起こします。
- リリース前のテストへの過度な投資（収益の減少の段階を過ぎたところまで）
- 本番環境でのテストに対する投資不足

本番環境でのテストについては、テスト専門家のチャリティ・メジャーズ氏の講演「Yes, I Test in Production (And So Should You)」をおすすめします。本番環境外では再現できない特徴もあります。例えば、データセットの大きさや予期せぬデータの組み合わせは、本番システムではユーザーによって発生するため再現困難です。また、本番環境のトラフィックも再現できず、複数のユーザーが同時にシステムを使用する状況も想定できません。

これらの特徴は、予測できないリスクを生み出し、本番環境以外で十分にテストできない状況を作ります。本番環境でのテストを実施することで、その条件を活用することができます。具体的には、本番環境特有の大規模なデータセットや予測不可能な同時アクティビティです。

ただし、本番環境以外でテストを実施することも重要です。それによって、以下のようなことを現実的にテストできます。
- 動作するか
- コードが実行されるか
- 予測可能な方法で失敗するか
- 以前に失敗した方法で失敗するか

本番環境でのテストは、予測不可能性のあるリスク、つまり未知のリスクに対処するためのものです。本番環境でのテストには新たなリスクも生じますが、これらのリスクを管理するためのいくつかのアプローチが存在します。それには、監視、可観測性、ダウンタイムなしのデプロイ、プログレッシブデプロイメント、データ管理、カオスエンジニアリング、監視をテストとして利用するなどが含まれます。

本章では、インフラストラクチャのテストの一般的な課題とアプローチについて説明しました。テスト、品質、リスク管理についての詳細は触れていませんが、これらに経験が少ない場合は、この章で十分に理解を深めることができるでしょう。インフラストラクチャとしてのコーディングにおいて、テストとQAは基本的な要素です。