Challenge: Testing Infrastructure Code Is Slow To test infrastructure code, you need to apply it to relevant infrastructure. And provisioning an instance of infrastructure is often slow, especially when you need to create it on a cloud platform. Most teams that struggle to implement automated infrastructure testing find that the time to create test infrastructure is a barrier for fast feedback. The solution is usually a combination of strategies: Divide infrastructure into more tractable pieces It’s useful to include testability as a factor in designing a system’s structure, as it’s one of the key ways to make the system easy to maintain, extend, and evolve. Making pieces smaller is one tactic, as smaller pieces are usually faster to provision and test. It’s easier to write and maintain tests for smaller, more loosely coupled pieces since they are simpler and have less surface area of risk. Chapter 15 discusses this topic in more depth. Clarify, minimize, and isolate dependencies Each element of your system may have dependencies on other parts of your system, on platform services, and on services and systems that are external to your team, department, or organization. These impact testing, especially if you need to rely on someone else to provide instances to support your test. They may be slow, expensive, unreliable, or have inconsistent test data, especially if other users share them. Test doubles are a useful way to isolate a component so that you can test it quickly. You may use test doubles as part of a progressive testing strategy — first testing your component with test doubles, and later testing it integrated with other components and services. See “Using Test Fixtures to Handle Dependencies” for more about test doubles. Progressive testing
You’ll usually have multiple test suites to test different aspects of the system. You can run faster tests first, to get quicker feedback if they fail, and only run slower, broader-scoped tests after those have passed. I’ll delve into this in “Progressive Testing”. Choice of ephemeral or persistent instances You may create and destroy an instance of the infrastructure each time you test it (an ephemeral instance), or you may leave an instance running in between runs (persistent instances). Using ephemeral instances can make tests significantly slower, but are cleaner and give more consistent results. Keeping persistent instances cuts the time needed to run tests, but may leave changes and accumulate inconsistencies over time. Choose the appropriate strategy for a given set of tests, and revisit the decision based on how well it’s working. I provide more concrete examples of implementing ephemeral and persistent instances in “Pattern: Ephemeral Test Stack”. Online and offline tests Some types of tests run online, requiring you to provision infrastructure on the “real” cloud platform. Others can run offline on your laptop or a build agent. Tests that you can run offline include code syntax checking and tests that run in a virtual machine or container instance. Consider the nature of your various tests, and be aware of which ones can run where. Offline testing is usually much faster, so you’ll tend to run them earlier. You can use test doubles to emulate your cloud API offline for some tests. See “Offline Testing Stages for Stacks” and “Online Testing Stages for Stacks” for more detail on offline and online testing for stacks. With any of these strategies, you should regularly assess how well they are working. If tests are unreliable, either failing to run correctly or returning inconsistent results, then you should drill into the reasons for this and either fix them or replace them with something else. If tests rarely fail, or if the same tests almost always fail together, you may be able to strip them out to simplify your test suite. If you spend more time finding and fixing problems that originate in your tests rather than in the code you’re testing, look for ways to simplify and improve them.
課題：インフラストラクチャのコードテストは遅い
インフラストラクチャのコードをテストするには、関連するインフラストラクチャに適用する必要があります。そして、インフラストラクチャのインスタンスをプロビジョニングすることは、クラウドプラットフォーム上で作成する必要がある場合には通常遅くなります。自動化されたインフラストラクチャテストを実装するのに苦労している多くのチームは、テストインフラストラクチャを作成するための時間が迅速なフィードバックの障害となる場合が多いとわかります。解決策は通常、次の戦略の組み合わせです： 
- インフラストラクチャをより扱いやすい部品に分割する
-  システムの構造設計にテスト可能性を考慮に入れることは有益であり、システムをメンテナンス、拡張、進化しやすくするための主要な方法の1つです。部品を小さくすることは、プロビジョニングとテストが通常よりも速くなるため、1つの戦術です。特にリスクの表面積が少なく、シンプルでローカップルの部品では、テストを書くことやメンテナンスすることが容易です。第15章ではこのトピックについて詳しく説明しています。
- 依存関係を明確にし、最小限にし、分離する
- システムの各要素は、システムの他の部分、プラットフォームサービス、およびチーム、部署、または組織とは異なるサービスやシステムに依存する場合があります。これらは特にテストに影響を与えます。特にテストをサポートするインスタンスを他の誰かに頼る必要がある場合、それらのインスタンスは遅く、高価で信頼性に欠けることがあります。また、他のユーザーと共有されている場合、テストデータが一貫性がない場合もあります。テストダブルは、コンポーネントを分離して迅速にテストできる便利な方法です。テストダブルを使用して、まずコンポーネントをテストし、後で他のコンポーネントやサービスと統合してテストするというプログレッシブテスト戦略の一部として使用することができます。テストダブルについては、「テストフィクスチャを使って依存関係を処理する」を参照してください。
- プログレッシブテスト
- 通常、システムのさまざまな側面をテストするために複数のテストスイートが必要です。失敗した場合により迅速なフィードバックを得るために、最初により速いテストを実行し、それらがパスした後により遅く、広範囲のテストを実行することができます。これについては、「プログレッシブテスト」で詳しく説明します。
- 一時的または永続的なインスタンスの選択
- テストするたびにインフラストラクチャのインスタンスを作成して破棄することができます（一時的なインスタンス）、または実行間にインスタンスを実行したままにすることができます（永続的インスタンス）。一時的なインスタンスを使用するとテストが大幅に遅くなりますが、クリーンで一貫性のある結果を得ることができます。永続的なインスタンスを保持すると、テスト実行にかかる時間が短縮されますが、変更が残り、一貫性のない問題が蓄積する可能性があります。特定のテストセットに適した戦略を選択し、その効果を定期的に評価する必要があります。「パターン：一時的テストスタック」では、一時的および永続的なインスタンスの具体的な実装例を提供しています。
- オンラインおよびオフラインテスト
- いくつかの種類のテストはオンラインで実行され、実際のクラウドプラットフォーム上でインフラストラクチャをプロビジョニングする必要があります。他のテストは、ラップトップやビルドエージェントでオフラインで実行できます。オフラインで実行できるテストには、コードの構文チェックや仮想マシンやコンテナインスタンスで実行されるテストが含まれます。さまざまなテストの性質を考慮し、どのテストをどこで実行できるかを把握しておく必要があります。オフラインテストは通常非常に速く、したがって早い段階で実行される傾向があります。クラウドAPIをオフラインでエミュレートするためにテストダブルを使用することもできます。オフラインおよびオンラインのスタックに対するオフラインおよびオンラインのテストについての詳細については、「スタックのオフラインテストステージ」と「スタックのオンラインテストステージ」を参照してください。
- これらの戦略のいずれかを使用する場合、定期的にその効果を評価する必要があります。テストが信頼性に欠ける場合、正しく実行されないか一貫性のない結果を返す場合は、その理由を詳しく調査し、それを修正するか別の方法に置き換える必要があります。テストがめったに失敗しない場合、または同じテストがほとんど常に一緒に失敗する場合は、テストスイートを単純化するためにそれらを削除できる場合があります。テストするコードよりもテスト自体から発生する問題を見つけて修正するのに時間を費やしている場合は、それらを単純化し改善する方法を探すべきです。