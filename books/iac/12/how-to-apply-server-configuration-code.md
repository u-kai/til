How to Apply Server Configuration Code Having described patterns to manage when to apply configuration code to servers, this section now discusses patterns for deciding how to apply the code to a server instance. These patterns are relevant to changing servers, particularly as a part of a continuous synchronization process (see “Pattern: Continuous Configuration Synchronization”). But they’re also used when building new server instances, to fry configuration onto an instance (see “Frying a Server Instance”). And you also need to choose a pattern to apply configuration when building server images (Chapter 13)Given a server instance, whether it’s a new one you are building, a temporary instance you use to build an image, or an existing instance, there are two patterns for running a server configuration tool to apply code. One is push, and the other is pull. Pattern: Push Server Configuration With the push server configuration pattern, a process running outside the new server instance connects to the server and executes, downloading and applying code. Motivation Teams use push to avoid the need to preinstall server configuration tooling onto server images. Applicability The push pattern is useful when you need a higher degree of control over the timing of configuration updates to existing servers. For example, if you have events, such as software deployments, with a sequence of activities across multiple servers, you can implement this with a central process that orchestrates the process. Consequences The push configuration pattern requires the ability to connect to server instances and execute the configuration process over the network. This requirement can create a security vulnerability since it opens a vector that attackers might use to connect and make unauthorized changes to your servers. It can be awkward to run push configuration for server instances that are created automatically by the platform (see “Configuring the Platform to Automatically Create Servers”); for example, for autoscaling or automated recovery. However, it can be done. Implementation One way to push server configuration is for someone to run the server configuration tool from their local computer. As discussed in “Applying Code from a Centralized Service”, however, it’s better to run tools from a central server or service, to ensure consistency and control over the process. Some server configuration tools include a server application that manages connections to machine instances, such as Ansible Tower. Some companies offer SaaS services to remotely configure server instances for you, although many organizations prefer not to give third parties this level of control over their infrastructure. In other cases, you implement a central service yourself to run server configuration tools. I’ve most often seen teams build this using CI or CD server products. They implement CI jobs or pipeline stages that run the configuration tool against a particular set of servers. The job triggers based on events, such as changes to server configuration code, or creation of new environments. The server configuration tool needs to be able to connect to server instances. Although some tools use a custom network protocol for this, most use SSH. Each server instance must accept SSH connections from the server tool, allowing the tool to run with enough privileges to apply its configuration changes.
It’s essential to have strong authentication and secrets management for these connections. Otherwise, your server configuration system is a huge security hole for your estate. When creating and configuring a new server instance, you can dynamically generate a new authentication secret, such as an SSH key. Most infrastructure platforms provide a way to set a key when creating a new instance. Your server configuration tool can then use this secret and potentially disable and discard the key once it’s no longer needed. If you need to apply configuration changes to existing server instances, as with continuous synchronization, then you need a longer-term method to authenticate connections from the configuration tool. The simplest method is to install a single key on all of your server instances. But this single key is a vulnerability. If it is exposed, then an attacker may be able to access every server in your estate. An alternative is to set a unique key for each server instance. It’s essential to manage access to these keys in a way that allows the server configuration tool to access them while reducing the risk of an attacker gaining the same access — for example, by compromising the server that runs the tool. The advice in “Handling Secrets as Parameters” is relevant here. One approach many organizations use is to have multiple servers or services that manage server configuration. The estate is divided into different security realms, and each server configuration service instance only has access to one of these. This division can reduce the scope of a compromise. Related patterns The alternative to the push pattern is the pull server configuration pattern. Pattern: Pull Server Configuration The pull server configuration pattern involves a process running on the server instance itself to download and apply configuration code. This process triggers when a new server instance is created. For existing instances under the continuous synchronization pattern, the process typically runs on a schedule, periodically waking up and applying the current configuration. Motivation Pull-based server configuration avoids the need for server instances to accept incoming connections from a central server, so it helps to reduce the attack surface. The pattern simplifies configuring instances created automatically by the infrastructure platform, such as autoscaling and automated recovery (see “Configuring the Platform to Automatically Create Servers”). Applicability You can implement pull-based server configuration when you can build or use server images that have your server configuration tool preinstalled. Implementation Pull configuration works by using a server image that has the server configuration tool preinstalled. If you are pulling configuration for new server instances, configure the image to run the tool when it first boots.
Cloud-init is a widely used tool for automatically running this kind of process. You can pass parameters to the new server instance using your infrastructure platform’s API, even including commands to execute, and parameters to pass to the server configuration tool (see Example 12-1). Example 12-1. Example stack code that runs a setup script server:
source_image: stock-linux-1.23
memory: 2GB
vnet: ${APPSERVER_VNET}
instance_data: - server_tool: servermaker - parameter: server_role=appserver - parameter: code_repo=servermaker.shopspinner.xyz Configure the script to download configuration code from a central repository and apply it on startup. If you use continuous synchronization to update running servers, the setup process should configure this, whether it’s running a background process for the server configuration tool, or a cron job to execute the tool on a schedule. Even if you don’t build your own server images, most of the images provided by public cloud vendors have cloud-init and popular server configuration tools pre-installed. A few other tools, notably Saltstack, use a messaging and event-based approach to trigger server configuration. Each server instance runs an agent that connects to a shared service bus from which it receives commands to apply configuration code. Related patterns The alternative to the pull pattern is the push server configuration pattern (see “Pattern: Push Server Configuration”).
サーバーの設定コードを適用する方法
サーバーへの設定コードの適用タイミングを管理するためのパターンを説明した後、このセクションでは、サーバーインスタンスにコードを適用する方法を決定するためのパターンについて説明します。これらのパターンは、特に継続的な同期プロセスの一部としてサーバーを変更する際に関連性があります（「パターン：継続的な設定同期」を参照）。ただし、「サーバーインスタンスのフライ」として、新しいサーバーインスタンスの構築時にも使用されます（「サーバーインスタンスのフライ」を参照）。また、サーバーイメージのビルド時に設定を適用するためのパターンを選択する必要もあります（第13章）。

あるサーバーインスタンスが与えられた場合、それがビルド中の新しいものであるか、イメージをビルドするために使用する一時的なインスタンスであるか、既存のインスタンスであるかにかかわらず、サーバーの設定ツールを実行してコードを適用するための2つのパターンがあります。1つはpushであり、もう1つはpullです。

パターン：プッシュサーバー設定
プッシュサーバー設定パターンでは、新しいサーバーインスタンスの外部で実行されるプロセスがサーバーに接続し、コードをダウンロードして適用します。

動機
プッシュを使用するチームは、サーバーイメージに事前にサーバー設定ツールをインストールする必要がないため、プッシュを使用します。

適用可能性
プッシュパターンは、既存のサーバーに対する設定の更新のタイミングをより細かく制御する必要がある場合に有用です。たとえば、ソフトウェアデプロイメントなど、複数のサーバー間での活動のシーケンスを持つイベントがある場合、プロセスを統合する中央プロセスでこれを実装できます。

結果
プッシュ設定パターンでは、サーバーインスタンスに接続して設定プロセスをネットワーク経由で実行する必要があります。この要件はセキュリティ上の脆弱性を作成する可能性があり、攻撃者がサーバーに接続して許可されていない変更を加えるために使用する可能性があります。プラットフォームによって自動的に作成されるサーバーインスタンス（「プラットフォームの自動的なサーバー作成の構成」を参照）のためにプッシュ設定を実行するのは不便かもしれません。ただし、これは可能です。

実装
サーバー設定をプッシュする一つの方法は、誰かが自分のローカルコンピューターからサーバー設定ツールを実行することです。ただし、「集中化されたサービスからのコードの適用」で説明されているように、プロセスの一貫性と制御を確保するために、ツールを中央サーバーやサービスから実行する方が良いです。Ansible Towerなど、サーバーインスタンスへの接続を管理するサーバーアプリケーションを含むいくつかのサーバー設定ツールがあります。一部の企業は、リモートでサーバーインスタンスの設定を行うためのSaaSサービスを提供していますが、多くの組織は自分たちのインフラストラクチャに対してこのレベルの制御を第三者に与えたくありません。その他の場合では、サーバー設定ツールを実行するために独自の中央サービスを実装します。CIやCDサーバー製品を使用して、CIジョブやパイプラインステージを実装して、特定のサーバーセットに対して設定ツールを実行するようにチームが構築することが最も一般的です。ジョブは、サーバー設定コードの変更や新しい環境の作成などのイベントに基づいてトリガされます。サーバー設定ツールはサーバーインスタンスに接続できる必要があります。一部のツールはカスタムネットワークプロトコルを使用していますが、ほとんどのツールはSSHを使用します。各サーバーインスタンスは、サーバーツールからのSSH接続を受け入れる必要があります。これにより、ツールが設定変更を適用するための十分な権限で実行できます。

これらの接続には、強力な認証とシークレット管理が必要です。そうでなければ、サーバー設定システムは貴重なセキュリティホールになります。新しいサーバーインスタンスを作成し構成する際には、SSHキーなどの新しい認証シークレットを動的に生成できます。ほとんどのインフラストラクチャプラットフォームは、新しいインスタンスを作成する際にキーを設定する方法を提供しています。サーバー設定ツールはこのシークレットを使用し、必要なくなったら無効にして廃棄することができます。継続的な同期のように既存のサーバーインスタンスに設定変更を適用する必要がある場合は、設定ツールからの接続を認証するための長期的な方法が必要です。最も簡単な方法は、すべてのサーバーインスタンスに単一のキーをインストールすることです。ただし、この単一のキーは脆弱性です。これが公開されると、攻撃者はエステート内のすべてのサーバーにアクセスできる可能性があります。代わりに、各サーバーインスタンスに固有のキーを設定することもできます。このキーへのアクセスを設定ツールが取得できるようにするために、ツールを実行するサーバーの侵害による同じアクセスのリスクを低減する方法でこれらのキーへのアクセスを管理することが重要です。ここでは、「パラメータとしてのシークレットの処理」のアドバイスが関連しています。多くの組織が使用するアプローチは、サーバー設定を管理する複数のサーバーやサービスを持つことです。エステートは異なるセキュリティ領域に分割され、各サーバー設定サービスインスタンスはこれらのいずれかにアクセスできます。この分割により、侵害の範囲が狭まります。

関連パターン
プッシュパターンの代替となるパターンは、プルサーバー設定パターンです。

パターン：プルサーバー設定
プルサーバー設定パターンでは、サーバーインスタンス自体でプロセスが実行され、設定コードをダウンロードして適用します。このプロセスは、新しいサーバーインスタンスが作成された時点でトリガーされます。継続的な同期パターン下の既存のインスタンスでは、プロセスは通常スケジュールされ、定期的に起動して現在の設定を適用します。

動機
プルベースのサーバー設定は、サーバーインスタンスが中央サーバーからの受信接続を受け入れる必要がないため、攻撃面を削減するのに役立ちます。このパターンは、自動的に作成されるインフラストラクチャプラットフォーム（自動スケーリングや自動リカバリなど）でインスタンスを構成することを単純化します。

適用可能性
サーバー設定ツールが事前にインストールされたサーバーイメージをビルドまたは使用できる場合、プルベースのサーバー設定を実装できます。

実装
プル設定は、サーバー設定