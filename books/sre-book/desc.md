# 序章

スケールしていくサービスを高い信頼性でかつできるだけ低コストで運用するにはどうすればいいのか？開発と運用を対立させずにユーザーに新機能を素早く提供するには？

あらゆる規模のサービスを運用に関わる様々な形で関わるすべての人に向けて

システムのトータルコストの 40 ~ 90%はそのシステムの誕生後に生じるものと推定されている

ソフトウェアエンジニア => 設計と構築に焦点を当てる

SRE => そもそもの始まりからデプロイと運用，改善，そして最終的に迎える平穏な撤去に至るソフトウェアライフサイクル全体に焦点を当てる

時には開発者とともに，システムのためにソフトウェアを書くことがタスクになったり，またあるときはシステムが必要とするバックアップやロードバランスのようなあらゆる付加的な各種ソフトウェアをできればシステム間にわたって再利用できるように構築することがタスクになる.また，ある時には既存のソリューションを新しい課題に適用する方法を見出すことがタスクになる

また SRE は，システムの信頼性に焦点を置く

信頼性こそがあらゆるプロダクトの基本的な機能と提唱する人も

# 1 章

- これまでの SysAd なやり方は標準化されており，いいように見えるが多くのデメリットが隠されている
- 開発／運用の分断もコストになる
- 二つのチームは異なる関心ごとを持っている

  - 開発は早くサービスをデプロイしたい
  - 運用は安定稼働させたいから変更は怖い

- 著者曰く，SRE とはソフトウェアエンジニアに運用チームの設計を依頼したときに出来上がる
- 求めている技術はソフトウェアエンジニアリングと，UNIX システム内部とネットワーキング(L1~L3)に関する専門知識
- 専門知識を使って運用チームが行ってきたことを自動化する
- その目的上，SRE チームはエンジニアリングに注力することが重要
- Google ではすべての SRE に対してチケット，オンコール，手作業といった運用業務(コードを書くことではないこと，エンジニアリングではないこと)の合計を 50％以下にするように上限を儲けている
- このために開発に注力している時間を計測しなければいけない
- 50％以上の運用業務が行われていれば，開発チームにバグチケットなどを割り当てる(戻す)
  - 50％以内になったら再度 SRE チームに割り当てる
- このアプローチがうまくいくのは組織全体，すなわち SRE と開発者がこの仕組みが存在する理由を理解し，運用負荷のオーバーフロが起こらない，そしてプロダクトが過大な運用負荷を生じさせないと言う目標を支持しているから

## サービスの SLO を下回ることなく，変更の速度の最大化を追求する

- プロダクト開発チームと SRE チームはそれぞれの目標における構造的な対立を取り除くことによって生産的な共同関係を享受できる
- エラーバジェットの導入によって解決する
- エラーバジェットは 100%を信頼性の目標とすることは基本的にいかなる場合にも間違っているという所見から来たもの
- 99.999%との違いは不安定なノイズであり，それを埋めるだけの膨大な労力はユーザーにとって何もメリットをもたらさない
- 何が正しい信頼性なのかはプロダクトの問題であり以下のことを考慮に入れるべき
  - プロダクトの利用方法を踏まえて考えた時，ユーザーが満足する可用性のレベルはどの程度か?
  - プロダクトの可用性に満足できなかったユーザーにとってどのような代替策があるのか？
  - 可用性のレベルを変更したとして，ユーザーのプロダクトの利用の仕方に何が起こるのか？
- 企業やプロダクトはシステムの可用性のターゲットをはっきりさせなければならず，そのターゲットがはっきりすればそこから 1 を引いたものがエラーバジェット
- エラーバジェットが超過するまではなんでもして良い

  - 素早い機能追加ができる
  - この機能追加もいろんなデプロイ方法を用いることで節約できる
    - ここら辺が k8s とかの強みよな

- およそ 70％のサービス障害は動作中のシステムの変更によって生じていることを発見
- この領域におけるベストプラクティスは自動化によって以下を実現すること
  - 漸進的なロールアウトの実装
  - 高速かつ，正確な問題の検出
  - 問題が生じた際の安全なロールバック

## 2 章

## 3 章

## サービスのリスク許容度

- 可用性のターゲットレベル
  - 以下のリストは考慮すべき事項
    - ユーザーが期待するサービスのレベル
    - サービスが直接的に収入に繋がっているか
    - サービスは有料か無料か
    - 市場に競合がある場合，その競合が提供しているサービスのレベル
    - サービスはコンシューマ向けか企業向けか

## エラーバジェットの形成

- プロダクトマネジャーが SLO を規定する
  - これは四半期内に期待されるサービス稼働時間を設定する
  - 実際の稼働時間は中立な第三者であるモニタリングシステムによって計測される
  - この 2 つの値の差異がその四半期内の損失可能な信頼性のという予算の残分となる
  - 計測された稼働時間が SLO を超えている，言い換えればエラーバジェットがまだ残っているなら新しいリリースをプッシュできる

## メリット

- エラーバジェットの主なメリットはプロダクト開発者と SRE に共通のインセンティブを提供し，両者がイノベーションと信頼性の適切なバランスを見出すことに注力できるようになること

## 4 サービスレベル目標

- SLI はサービスレベル指標

  - 多くのサービスでは重要な SLI としてリクエストのレイテンシーを考慮する
  - 他のものではエラー率やシステムスループットがある
  - 可用性も大切

- SLO はサービスレベル目標
  - これは SLI で計測されるサービスレベルのターゲット値またはターゲット値の範囲
  - 例:検索リクエストに対する平均レイテンシーが 100 ミリ以下
  - SLO をしっかり明示することでユーザーのサービスへの期待を調整することができる
- SLA はユーザーとの間で結ぶ明示的，あるいは暗黙的な契約であり，その中に含まれる SLO を満たした場合(または見たなさなかった場合)に関する規約が含まれる
- SLO との違いは破った時にどうなるか明確なものがあるかどうか
  - SLO は破っても何もない
  - SLA は破ったら何かしらの契約事項がある
- 通常 SRE は SLA に関わらない
  - SLA はビジネスやプロダクトに関わる判断に密接に関わるものだから
  - SLO の違反の規定を実行するようなことが生じないようにすることには関わる
  - SLI の計測や SLO の設定に関わる

## 指標の実装

- 指標は多すぎても少なすぎてもダメ
- システムによって，ユーザーが期待するべきことに指標をおくべき

  - ユーザーとやり取りするサーバーシステム
    - 可用性，レイテンシー，スループット
  - ストレージシステム
    - レイテンシー，可用性，耐久性
  - ビッグデータシステム
    - スループット，エンドツーエンドのレイテンシー
  - 正確性はすべてのシステムで注意するべし

## 指標の標準化

- 一般的な SLI についてはその定義を標準化し，毎回 1 から考えなくて済むようにしておくことがおすすめ
- 標準的な定義のテンプレートに従う機能は，個々の SLI の使用からは省略してもよい
  - 集計のインターバル
  - 集計の対象領域
  - 計測の頻度
  - 対象となるリクエスト
  - データの取得方法
  - データアクセスの例天使

## 目標の実際

- まずは自分たちが計測できることではなく，ユーザーが気にすることが何かを考える
- 単純に計測しやすいことから始めてしまったら，あまり有益ではない SLO ができてしまう
- できるだけ定義を明確にするために，SLO では計測の方法と計測値が適正である条件を指定するべき
  - Get RPC 呼び出しの 99％(1 分間の平均)が 100 ミリ秒以下で完了すること
- SLO を常に満たし続けることを求めることは現実的でも望ましいことでもない
  - それはインベーションとデプロイのペースを落とし，高価で過剰に保守的なソリューションを必要とすることにつながる
- それよりも SLO を満たさない比率を示すエラーバジェットを認め，日毎や週ごとに追従した方が良い

## ターゲットの選択

- ターゲットの選択は純粋に技術的な活動というわけではない

- 現状のパフォーマンスに基づいてターゲットを選択してはならない
  - システムのメリットと限界を理解することは欠かせないが，熟考することなく，値を決定してしまえば，ターゲットを満たすのに超人的な努力が必要で大幅な再設計をしないと改善できないシステムのサポートをし続けるハメになってしまうかもしれない
- シンプルさを保つ
  - 複雑な集計を伴う SLI はシステムのパフォーマンスの変化をぼかしてしまい，その原因の追求も難しくしてしまうかもしれない
- 絶対は避ける
- SLO は最小限に止める
- 最初から完璧でなくても良い

## 計測値のコントロール

1. システムの SLI のモニタリングと計測を行う
1. SLO に対して SLI を比較し，アクションが必要かを判断する
1. アクションが必要なら，ターゲットを満たすために実現しなければいけないことを明らかにする
1. 行動に移す

- SLO があることでアクションすべきかどうかが判断できるようになる

## SLO による期待の設定

- SLO を公開することによってシステムの挙動に対してどのような期待がおけるかが定まる
- 現実的な期待をユーザーのために設定するには以下のような戦略を検討すると良い
  - 安全マージンを確保する
  - 過剰達成を避ける
    - ユーザーは提供されると言われたものに基づくのではなく，実際に提供されるものに基づいて構築を行う
    - これは特にインフラサービスに当てはまる
    - サービスの実際のパフォーマンスが SLO を超えている場合，ユーザーは SLO を超えたパフォーマンスに依存するようになる
    - 時折意図的にシステムをオフラインしたり，一部のリクエストにスロットリングをかけたり，低負荷の際にもシステムが高速に動作しないように設計すれば過度に依存されるのを避けることができる

## 5 トイルの撲滅

- トイルとはプロダクションサービスを動作させることに関係する作業で，手作業で繰り返し行われ，自動化することが可能であり，戦術的で長期的な価値を持たず，作業量がサービスの成長に比例するといった傾向を持つもの

- 特徴
  - 手作業であること
  - 繰り返されること
  - 自動化できること
  - 戦術的であること??
    - 戦略的であったり予測に基づくものではなく，割り込みで始まり，問題などが生じたことへの対応として行われる作業
    - アラート対応はトイル
- 長期的な価値を持たないこと
  - あるタスクを終えた後でも，サービスが同じ状態のままのであれば，そのタスクはおそらくトイル

## エンジニアリングであるための条件

- 典型的な SRE の活動はおおよそ以下のように分類できる
  - ソフトウェアエンジニアリング
  - システムエンジニアリング
  - トイル
  - オーバーヘッド
    - サービスを稼働させることに直結していない管理的な作業
      - 例としては採用，人事の事務作業，チーム／会社ミーティング，トレーニングなど...
- すべての SRE はいくつかの四半期あるいは 1 年通して平均してみた時に，自分の時間のうち，最低 50％をエンジニアリングの作業に充てていないといけない
- もしこれに満たないのであれば，何が問題なのかを確認する必要がある

## トイルは常に悪なのか？

- 必要なこともある
- 悪なのは大量に処理しなくてはいけない時
- トイルが多すぎてキャリアの停滞や，モラルの低下が起きてしまうかもしれない
- 加えてエンジニアリングに使うべき時間までトイルに時間を使いすぎると SRE の組織には以下のようなダメージが生じる
  - 混乱の発生
    - SRE の役割が不明瞭になる
    - 進捗速度の低下
    - 習慣づけ
    - 摩擦の発生
    - 信義違反

## 6 分散システムのモニタリング

## 定義

- モニタリング
  - システムに関するリアルタイム定量データの収集，処理，集計，表示を行うこと
  - 扱うデータの例としては，クエリの回数と種類，エラーの回数と種類，処理時間，サーバーの生存時間などがある
- ホワイトボックスモニタリング??
  - システムの内部によって公開されているメトリクスに基づくモニタリング
- ブラックボックスモニタリング
  - ユーザーが目にする外部の振る舞いをテストする
- ダッシュボード
  - サービスの主要メトリクスのサマリビューを提供するアプリケーション
  - ダッシュボードはユーザーにとって最も重要なメトリクスを表示するようあらかじめ構築されているが，フィルタ，セレクタ，などを持っていることもある
- アラート
  - 人間に読まれることを意図した通知で，バグやチケットキュー，メールアドレス，ページャーなどのシステムにプッシュされる
- 根本原因
  - システムの問題の原因となっているもので修正すればもう同じことは起きないもの
- ノードとマシン
  - カーネル 1 つのインスタンスを指す言葉

## モニタリングの必要性

- 長期的なトレンドの分析
- 時間や実験グループ間での比較
- アラート
- ダッシュボードの構築
  - ダッシュボードはサービスに関する基本的な疑問に答えるべきもので，通常は何らかの形で 4 大シグナルを含む
- アドホックな振り返り分析の進行(デバッグなど)

## 症状と原因

- モニタリングシステムは 2 つの疑問に答えなければいけない
  - それは何が壊れたのか，なぜそれが壊れたのかという疑問

## ブラックボックスとホワイトボックス

- デバッグのためのテレメトリを収集しているのであればホワイトボックスモニタリングは欠かせない
- ページングについてブラックボックスモニタリングには大きなメリットがある
  - それは人間の手を煩わせるのは問題がすでに進行していて実際の症状に影響している時に限るという原則を強制できるということ

## 4 大シグナル

- レイテンシー
- トラフィック
- エラー
- サチュレーション
  - サービスがどれだけ手一杯になっているかを示す
  - 多くのシステムでは利用率が 100％に達する前にパフォーマンスの低下が生じることになるので利用率のターゲットを必ず設定しておくということ

## テイルレイテンシーに関する概念(あるいはインスつるメンテーションとパフォーマンス)

- 平均では意味がないことがある？？

## 適切な計測の粒度の選択

- システムのさまざまな側面は粒度のレベルを変えて測定すべき
  - 1 分ごとの CPU 負荷を観察しても，高いテイルレイテンシを生じさせるスパイクはそれが長時間にわたるものであっても見つけられないかもしれない
  - 一方年間で合計 9 時間未満の停止時間をターゲットとする Web サーバーの場合，200 のステータスの確認頻度を 1 分間に 1 回か 2 回以上にするのはやりすぎ
  - 同様に 99.9%の可用性をターゲットとするサービスのハードドライブの空き容量のチェックは 1 分から 2 分に 1 回以上にする必要はない

## 可能な限りシンプルに，ただしやりすぎないこと

- これらの要素をすべて積み上げるとモニタリングシステムは非常に複雑なものになってしまうかもしれない
- そして最終的には以下のようなレベルの複雑さをもつシステムになってしまうかもしれない
  - さまざまなメトリクス，レイテンシーの閾値，パーセンタイルによるアラート
  - 考えられる原因を検出して知らせるための追加コード
  - 考えられる原因のそれぞれに関連するダッシュボード
- モニタリングシステムの設計をする際にはシンプルさに目を向けておくようにすべき
- モニタリングの対象を選択する上では以下のガイドラインを念頭に置くこと
  - 本当のインシデントを最も頻繁にとらえるルールは可能な限りシンプルで予想しやすく，信頼できるものであるべき
  - ほとんど実装されていない(例えば SRE チームによっては四半期に 1 回未満)データの収集，主計，アラートの設定は削除すべき
  - 収集されてはいても事前に作成されたダッシュボードに表示されておらずどのアラートにも使われていないデータは削除の候補

## 原則の取りまとめ

- モニタリングやアラートのルールを作成する際には以下の質問をしてみると誤検知やページャーによる燃え尽き症候群を避ける役に立つ
  - ルールが検出する状況はそのルールなしでは検出されない状況であり，緊急で対応が可能で現時点，あるいは近未来にユーザーに影響を及ぼすことになる
  - そのアラートが無害なものだと判断して対応せずにそのままして置けるかどうか？どういた時にそして，どういった理由でそのアラートは無視できるのか？こういった状況が生じないようにするにはどうすればいいのか？
  - このアラートは間違いなく，ユーザーに悪影響が生じていることを示しているのか？ユーザーに悪影響が生じていないのに検出されてしまうような除外すべきケースではないのか？
  - このアラートに対応してアクションを撮ることができるのか？そのアクションは緊急なのか？それとも翌朝まで待つことができるのか？そのアクションは長期間にわたる修正効果を持つものなのか？それとも短期間だけ有効な回避策か？
  - この問題でページを受ける人は他にもいるかどうか？そうであるなら少なくともページの 1 つが不要だということではないか？
- 以下の質問はページおよびページャーに関する基本哲学を反映したもの
  - ページが来るたびに緊急事態という感覚を保って対応できなければならない.緊急事態という感覚を保って対応できるのは 1 日に数回が限度でそれ以上なら疲弊し始めることになる
  - 全てのページは具体的な対応が可能でなければならない
  - あらゆるページは対応に知性が必要なものでないといけない
  - ロボット的なレスポンスを返せばいいだけのページはそもそもページとするべきでない
  - ページは新たな問題か，これまでみられたことがないイベントに関するものであるべき

## 長期間にわたるモニタリング

- モニタリングに関する判断は長期的なゴールを念頭に置いて下すことが重要
- 今日発生している一つ一つのページに人が対応するということはそれだけ明日のためのシステムの改善に充てる時間がなくなるということ
- そのためシステムの長期的な展望を改善するために，可用性やパフォーマンスの短期的な低下を受け入れることもしばしばある
- 全てのページを独立したイベントとして捉えるのではなく，ページの全体的なレベルが健全で持続可能なチームと長期的な展望をもたらし，ひいては健全で適切な可用性をもつシステムへと繋がることになっているかということ

## 7:Google における自動化の進化

- 自動化の価値
  - 一貫性
  - プラットフォーム
    - プラットフォームには間違いを集約してくれる利点もある
  - 高速な修復
  - 素早いアクション
  - 時間の節約
    - 時間の節約はそのツールを使う人全てにスケールする
