# Managed Lifecycle

- Managed Lifecycle パターンはどのようにライフサイクルイベントに反応すべきかのパターン

## postStart

- コンテナが作られた後に実行される
  - コンテナの動作とは非同期で実行される？
- blacking call なので postStart が終わるまではコンテナのステータスは waiting らしい
- コンテナのアプリの初期化を待たせたい時に有用？

  - 逆にいうとコンテナのステータスが Running になるのっていつ？
  - 最後コマンドで./main のようにやってもそれはバックグランドの話で、それが実行された時点でコンテナは Running ってことかな？
  - 逆にそうじゃないと Job 的なものは終了するまで Peding になるのでそんな気がしてきた
  - だからこの postStart で Waiting の状態にできる感じなのは有用ってこと？
  - でも Running と Waiting の違いが他のコンテナに影響を及ぼすことがどんだけあんのかね

- 似たような気がするけど、事前条件みたいなものを満たさないと言ったことを防ぐことができる
- もしも postStart がミスったら K8s に main コンテナを殺してもらうこともできる

  - ただし注意点としては main コンテナと postStart は並列に、非同期に行われるので、コンテナの状態に依存するような postStart は注意

- postStart はそのままコマンドを実行するものや httpGet というマネジどな仕組みを使うこともできるみたい

  - 正直厳格なプラットフォームを作るのであれば必要そうな機能ではあるがいまいち使い道がわからん

## PreStop Hook

- SIGTERM notification の前に絶対実行されるもの？
- コンテナが殺される前に実行される感じ？
- ただし、コンテナの削除あプロセスの終了を防ぐことはできない？
- SIGTERM 以外の唯一の代替案？
- よくわからん
- コンテナの終了をコントロールする一つの案って感じかな

## Other Lifecycle Controls

- Lifecycle hooks と Init conainers という仕組みがある

- init containers はすべてコンテナが始まる前にすべての処理を成功していないといけない

  - こっちの方がしっくりくる

- Lifecycle hooks の使い道はクリティカルではないスタートやシャットダウンに特定のコンテナを綺麗にする時？(意味がわかるようなわからんような)
- init containers は、コンテナを使って workflow のような連続的なオペレーションをするとき、コンテナをタスク実行に再利用する時
  - ますます意味わからん
  - 消し込まずにいられるってこと？
- entry point を書き換える方法などがあるみたいで Tekton とか ArgoCD はサイドカーでこれをやっている
- ただし、init contaienr でサイドカーはできない
- containers.spec.command でコンテナが起動するときに実行してほしいコマンドを実行できるみたい

- Tekton では上記の方法を使って Pod 内のコンテナの起動順番などをコントロールしているみたい
  - いまだによくわからんが、こういうことをしたければこの章を見れば良いことはわかった

## Discussion

- cloud native なプラットフォームの利点は信頼性や予測性をスケールさせること、信頼できないクラウドのインフラストラクチャー上で
- アプリケーションのライフサイクルをマネジメントするのは k8s のようなオーケストレーションプラットフォーム
