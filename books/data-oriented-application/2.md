# 2 データモデルとクエリ言語

- データモデルはソフトウェアにできること、できないことに関して大きな影響を及ぼすのでアプリケーションに適したデータモデルを選択することは重要

## リレーショナルデータモデルとドキュメントモデル

- リレーションは順列無しのタプル
- リレーショナルモデルは理論として提唱されたもの
- RDB は 25 年から 30 年にわかって支配的だった(IT の時間で言うと永遠な時間)
- RDB の起源はビジネスデータ処理にある

  - トランザクション処理
  - バッチ処理

- リレーショナルモデルが目標としていたのはクリーンなインターフェイスによって背後の実装の詳細を隠蔽すること
- いろんな対抗馬が出てきたが RDB は勝ち上がっていた
  - ビジネスデータの処理以外にも使えることがわかってきた
- 今でも多くの用途に RDB は使われている

### NoSQL の誕生

- NoSQL データベースの採用が広がった要因は以下の様なことがある
  - 極めて巨大なデータセットや優れた書き込みスループットを含むリレーショナルデータベースで容易に実現できる以上のスケーラビリティが求められる様になったこと
  - 商用のデータベース製品よりも、フリーでオープンなソフトウェアが好まれることが多くなったこと
  - リレーショナルモデルではうまくサポートされない特殊なクエリ操作
  - リレーショナルなスキーマ制約に対するフラストレーションと、もっと動的で表現力に富んだデータモデルに対する欲求

### オブジェクトとリレーションのミスマッチ

- RDB を使うと,プログラム内のオブジェクトと RDB からのデータに変換のレイヤーができてしまう、インピーダンスミスマッチがあった
- ドキュメントモデルの DB を使えば解決できるかもしれないが、スキーマがないことなどの問題もある

### 多対一と多対多の関係

- ID を保存するか文字列を保存するかは複製の問題
- ID をつかえば人間にとって意味のある文字列は 1 箇所のみに保存され、この情報を参照する全てで ID が使われることになる

- テキストを直接使う場合、人間にとって意味のある情報をそれが使われるすべてのレコードで複製しなくてはいけない
  - どこかに更新がされると全てに更新をしなくてはいけなくなる
- このような複製を排除する考え方が正規化の鍵となる考え方

- ドキュメントモデルには結合がサポートされていないので、アプリケーションが成長して新しいデータの概念などが増えたときに大変

  - 一対多の関係には向いているが、多対多には向いていない
  - アプリケーション内で結合処理などを適切に行う必要がある

- RDB であれば結合は簡単

### ドキュメントデータベースは歴史を繰り返すのか

- ドキュメントデータベースに似ている階層型モデル制約を解決するために、リレーショナルモデルとネットワークモデルが提唱されていた

### ネットワークモデル

- 改装モデルではすべてのレコードは必ず 1 つの親を持つが、ネットワークモデルではレコードは複数の親を持つこともできる
  - これによって多対多も表現できる
- しかし、ネットワークモデルを扱う場合、同じレコードに辿り着くためのパスは複数ある可能性がある

  - アプリケーションは様々な関係をすべて追従しないといけない

- 階層モデルとネットワークモデルでは求めるデータへのパスがわかっていないという状況は厄介だった

### リレーショナルモデル

- リレーショナルモデルではすべてのデータはオープンに配置されていた
- リレーションは単なるタプルでありそれだけ

  - 複雑にいれこんだ構造もなくアクセスパスをたどる必要もない

- リレーショナルデータベースでは最適化の責任が開発者ではなくクエリオプティマイザであったことが大きい

### ドキュメントデータベースとの比較

- 多対一や多対多の関係の表現と言う点ではリレーショナルデータベースとドキュメントデータベースに基本的な違いはない
- どちらの場合でも、関連性のあるアイテムはユニークな識別子で参照される
  - リレーショナルモデルでは外部キー
  - ドキュメントモデルではドキュメント参照と呼ばれる

## 今日のリレーショナルデータベースとドキュメントデータベース

### アプリケーションのコードをシンプルにしてくれるデータモデルは？

- アプリケーションのデータがドキュメントの様な構造をしているのであればドキュメントモデルが良い
  - 一対多の関係からなるツリー構造を持ち、通常はそのツリー全体が一度にロードされる
- リレーショナルな手法である細分化はスキーマが込み入ったものになりアプリケーションのコードが不必要に複雑になることがある

- ドキュメントモデルはネストされたアイテムへは直接参照しないといけないので、ネストが深いと少し厄介
- アプリケーションが多対多をサポートする必要があるのであればドキュメントモデルの魅力が薄れる
- 非正規化によって結合の必要性を下げることができるが、データの整合性を保つためのコードが必要になる
- 結合はアプリケーション側でエミュレートできるが、アプリケーションコードを複雑にする
- パフォーマンスも悪い
- データ間の関係性が強い場合、ドキュメントモデルは扱いにくく、リレーショナルモデルは許容範囲であり、グラフモデルが最も自然

### ドキュメントモデルにおけるスキーマの柔軟性

- ドキュメントモデルはスキーマレスなのではなく、スキーマオンリーど
- リレーショナルモデルはスキーマオンライと
- スキーマオンリーどは動的型付けみたいな感じで、スキーマオンライとは静的型付けみたいな位置付け
