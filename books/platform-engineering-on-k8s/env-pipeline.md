- Jenkins のようなツールは手動によるデプロイよりも、環境のクレデンシャルへのアクセスの面やログの面で良いが、環境を分ける時はまだ課題がある
- なんか VM の話をしている感じがある
  - Ansible はそこを解決しているよねみたいな
- Jenkins は命令的なアプローチなんか？宣言的ではない？

  - これがめっちゃよくないよねとのこと

- VM は重いし、OS が動くことは別にビジネス価値があるわけではない

- 環境の設定はバージョン管理されずに、Jenkins とかに隠されることがあるとのこと

  - これはリスク
  - Jenkins ってそんなに行けてないの？

- 多分上の話は Ansible とか Jenkins で VM のクラスターを作ろうって話だと思う
- 今は K8s だよね？って感じのことを述べている
- k8s は VM のオーバヘッドを解決した
- そしてクラウドベンダーは K8s の API を幅広く採用している
- K8s が提供しているビルディングブロックは新いサービスをデプロイするのに他のやつをシャットダウンしたり、コンフィギレーションを変更する必要もない
- ダウンタイムもなしにできる
- ただし、k8s だけではクラスターのコンフィギレーションをを自分自身で解決することはできな
- これが GitOps が必要な理由

- GitOps には４つの定義がある

  - 宣言的
    - 何がほしいかを書く
    - 何をどうやって作るかは書かない
  - バージョン管理されていて、イミュータブル
    - 実は Git に限らんでいいらしいけど、バージョン管理とイミュータブルであることは担保しろよ
  - 自動的に pull する
  - 定期的にチェックする
    - 堅牢性を担保できる

- GitOps ツールが environment pipelines を定期的に実行して、宣言的な環境に保つ

- git にどう YAML を入れていくのかはいくつかの方法がある

  - 環境ごとのディレクトリに全ての YAML を入れる場合はシンプルだけどメンテナンスが大変
  - helm を利用したクラスター定義は一気にできるところはいいけど、変更ごとに１つの HELM リリースを作成し、サービス個別のリリースができないことがいやだ
  - helm の依存関係を使用して各サービス定義をフェッチするため、このアプローチの前提条件は全てのサービスパッケージを helm チャートとして持つこと
    - らしいけど、別に個別に作ってもいいのでは？
      - env/service みたいなディレクトリにしたら別に helm 分けられるよな？
      - そんなことないのか？
      - そもそもそのやり方が非推奨なのか？

- 一つの環境に一つの namespace と言うやり方で行くならリポジトリを環境ごとに分けると、隔離とセキュリティの観点で良い

  - 構成が相当複雑じゃね？

- ただ namespace の分離は結局クラスター自身は関与するので、分離レベルは低い
- 一つの環境ごとに新しいクラスターを作る場合は、分離とコントロールがしやすい
- 違うクラスターを使えばマルチクラウドのセットアップも可能

- Service Git Repository と Environment Git Repository は分けている模様
- Service Pipeline でビルドとかされたら最後に Environment Pipeline で必要なものをまとめて通知する(例えばバージョンなど)

  - イメージのタグ付けとかは、言うなれば Service Pipeline と Environment Pipeline の契約みたいなものか？
  - これがうまく成立していないと、そもそもすぐにデプロイみたいなことはできない気がする
  - この通知は自動のプルリクエストであることが良い
  - Git の代わりにアーティファクトリポジトリの変更を受け取って pull req を作成することもできる

- Environment Pipeline にきた pull req は特別な環境でテストされるべし

  - もしテストが通って、リスクが低いのであれば自動マージされる

- こうやってどんどん自動化していけば、開発者はバグ修正と開発に集中できる

- 開発環境のような開発者が直接触りたいところは GitOps で管理しない
