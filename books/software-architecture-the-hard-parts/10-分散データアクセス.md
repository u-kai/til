# 10 分散データアクセス

## サービス間通信データアクセスパターン

-   最もシンプルなやり方
-   ただし，レイテンシーや，サービス間の密な結合，耐障害性やスループットに問題があることがある

## 列スキーマレプリケーションパターン

-   このパターンでは列データをテーブル間でレプリケートすることで，他の境界づけられたコンテキストでデータを利用できるようにする
-   課題としては，データ同期とデータ整合性

    -   変更通知はキューやトピック，イベントストリームを利用した非同期通信によって行われる

-   もう一つの課題として，データ所有権の管理が困難な場合があること

    -   他のサービスが勝手にデータ更新することができてしまう

-   このパターンでは，読み取りが早くなり，パフォーマンス，耐障害性，スケーラビリティが向上する

## レプリケーションキャッシュパターン

-   レプリケーションキャッシュは他のキャッシュモデルとは異なり，データは各サービスのメモリ上に保持され，全てのサービスが常に同じデータを持つように継続的に同期される
-   分散キャッシュはデータは各サービスの内部ではなく，外部のキャッシュサーバーに保持される

    -   サービスは独自のプロトコルを使用してキャッシュサーバーにリクエストを行い，共有データを取得または更新する
    -   インメモリキャッシュとは異なり，データはサーバ間で共有される

-   分散キャッシュはいくつかの理由からレプリケーションキャッシュによるデータアクセスパターンに使用するには有効なキャッシュモデルとは言えない

    -   サービス間通信パターンの先がキャッシュサーバになったので，耐障害性やレイテンシーの問題などは残る
    -   複数サービスがデータ所有してしまう問題もある

-   レプリケーションキャッシュではそれぞれのサービスのインメモリデータがサービス間で同期されることで，同じデータを複数のサービスで共有できる
-   あるキャッシュに更新が行われると，その更新は直ちに同じキャッシュを使用している他のサービスに非同期に伝搬される
-   このパターンの利点は応答性，耐障害性，スケーラビリティ
-   このパターンの最初のトレードオフは，キャッシュデータと起動タイミングに関するサービス依存関係
-   もう一つはデータ量

    -   データ量が 500MB を超えるような場合，実現性が急激に下がる
    -   アーキテクトはキャッシュのサイズとキャッシュデータの両方を必要とするサービスインスタンスの総数の両方を分析してレプリケーションキャッシュに必要なメモリ総量を決定する必要がある

-   3 つ目のトレードオフは，データ変更頻度が多すぎるものに対しては，サービス間でデータを完全に同期できなくなる可能性があること

    -   変わりやすいデータに対してこのパターンはあまり適していない
    -   比較的静的なデータ関してはうまくいく

-   最後のトレードオフは構成や設定の管理 -　クラウド環境などの IP が固定化されない場合に，インスタンスを探すのに時間がかかる可能性がある

## データドメインパターン

-   分散アーキテクチャではデータの共有は一般的には推奨されないものの，このパターンには他のデータアクセスパターンにない大きなメリットがある

    -   まず，サービス同士が完全に切り離されているため，可用性の依存関係，応答性，スループット，スケーラビリティといった問題が解消される
    -   このパターンでは通常の SQL 呼び出しでデータを利用できるため，応答性が高い
    -   データの一貫性と整合性の両方がとても高い

-   トレードオフとして，データドメインないのいずれかのテーブル構造が変更された時，複数サービスにも変更が必要になる

    -   広い範囲の境界づけられたコンテキストとなる

-   もう一つの欠点はデータアクセスに関するセキュリティリスク
    -   データドメインにアクセスするサービスが特定のデータにはアクセスすべきではない場合もある
