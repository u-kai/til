# 14 分析データの管理

## データウェアハウス

-   データウェアハウスパターンの主な特徴

    -   多くのソースから抽出されたデータ
        -   業務データはここのデータベースに格納されており，デー他を別のデータストアに抽出するメカニズムが規定されている
        -   組織内の全てのデータベースを紹介してレポートを作成するのは現実的でないため，データは分析目的のためだけにウェアハウスに抽出された
    -   シングルスキーマに変換

        -   業務システムではトランザクションを中心にスキーマや動作を構成する必要があるが，分析システムで OLTP(オンライントランザクション処理) データを扱うことはほとんどない
        -   代わりにレポート作成や集計などのための大量データを扱うのが一般的
        -   そこでほとんどのデータウェアハウスではスタースキーマをりよしてディメンショナルモデリングを実施し，業務システムから抽出された形式の異なるデータをウェアハウスのスキーマへと変換する
        -   データウェアハウスの設計者はスピードとシンプルさを追及するためにデータを非正規化し，パ f ーマンスとシンプルなクエリを再現する

    -   ウェアハウスのロード
        -   業務デーは個々のシステムに存在するため，ウェアハウスでは定期的にデータを抽出し，変換してウェアハウスに配置する仕組みを構築する必要がある
        -   設計者はレプリケーションのようなリレーショナルデータベースに組み込まれたメカニズムを利用するか，専用のツールを使用して元のスキーマからウェアハウスのスキーマへの変換機能を構築する
        -   もちろん業務システムのスキーマを変換した場合は，返還後のスキーマにも反映させなければいけないので，変更の調整が困難になる
    -   データアナリストによって利用される

        -   データウェアハウスはデータアナリストレポートなどの BI 資産を構築するのに活用される
        -   有用なレポートの作成にはドメインに対する理解が求められる
        -   データアナリストが有用なレポートや BI を構築するには返還後のスキーマ上で元のスキーマと同じデータを復元するクエリを設計する必要がある

    -   BI レポートとダッシュボード
        -   データウェアハウスの出力には，BI レポート，分析データを提供するダッシュボード，レポート，その他企業がより良い意思決定を行えるためのあらゆる情報が含まれる
    -   SQL 的なインターフェイス
        -   DBA が使いやすいように，ほとんどのデータハウスのクエリツールはクエリを生成するために SQL に似た言語を提供している

-   データウェアハウスパターンはソフトウェアアーキテクチャにおける技術による分割の良い例
-   ウェアハウスの設計者はクエリや分析を容易にするスキーマにデータを変換するが，それによってドメインによる分割は失われ，必要に応じてクエリで際生成しなければいけなくなる

    -   そのためこのアーキテクチャでのクエリ生成方法を理解するには高度な訓練を受けた専門家が必要となる

-   データウェアハウスパターンの主な欠点は，統合のもろさ，ドメイン知識の極度な分割，複雑さ，意図した目的に対する機能の制限など

    -   結局コスト以上の価値を創出するのが難しいもの

### スタースキーマ

-   データマートやウェアハウスで人気のパターン
-   スタースキーマはデータのセマンティクスを組織の定量可能なデータを保持するファクトと，ファクトデータの記述的な属性を含むディメンションに分離する
-   ファクトの例としては，時給，修理にかかる時間，顧客までの距離といった具体的な測定可能なものが挙げられる
-   ディメンションにはエキスパートの専門分野，名前，店舗所在地などのメタデータが含まれる
-   最も重要なことは，意図的に非正規化されることで，よりシンプルなクエリ，シンプルなビジネスロジック，高速なクエリ集約，データキューブなどの複雑な分析，マルチディメンションクエリの形式を容易にできる

## データレイク

-   データウェアハウスの複雑さ，コスト，失敗に対する多くの反動によって，設計の振り子は反対方向に極に触れた
-   その一つがデータレイクパターン
-   データレイクパターンは一元化されたモデルとパイプラインはそのままに，データウェアハウスの変換してロードするモデルをロードして変換するモデルに反転させた
-   データレイクパターンの哲学は必要のない無駄な変換をデータに行わないことで，通常だと目的のために変換やマスキングが行われてしまう分析データへビジネスユーザーが自然な形でアクセスできるようにするというもの
-   このようにして変換作業の負担はプロアクティブからリアクティブになった
    -   つまり必要な時にだけ変換作業を行うということ

### 特徴

-   多くのソースから抽出されたデータ
    -   別のスキーマへの変換は多少は行われるものの，データは生の形式で保存されることが多い
-   データレイクへのロード

    -   クラウド環境に導入されることが多いデータレイクは，業務システムからの定期的なデータダンプで構成されている

-   データサイエンティストによって利用される

    -   データサイエンティストはその他の分析データの利用者はデータレイク内のデータを発見し，特定の問合せに答えるために必要な集約，合成，その他の変換を行う

-   このパターンは依然として一元管理的なビューを採用している
-   データは業務システムのデータベースから抽出され，多かれ少なかれ任意の形式でデータレイクへとレプリケートされる
-   データウェアハウスでよく起きていた問題は計画段階にもかかわらず，異種のデータセットを繋げる方法を見つけなくてはならないというものだった

    -   その結果，データウェアハウスでは，一部の分析で事前作業が必要なのであれば，全てのデータに対してそれを行い，それによって大規模な先行投資を回避しようという論証が優っていた

-   データレ行くパターンはデータウェアハウスパターンが抱えていたデータ変換に伴うそうした問題の幾つが解決したものの，全ての問題に対処できたわけではなく，新たな問題も作り出した

-   適切な資産の発見が困難になる
    -   ドメイン知識の蒸発
-   個人情報及び，その他の機密データ
-   技術による分割ではなく，ドメインによる分割

    -   データウェアハウスもデータレイクも取り込み，変換，読み込み，提供といった技術的分割に重点が置かれているため

-   技術による分割とバッチ的な性質の両方が原因でソリューションはデータの陳腐化に悩まされる可能性がある
    -   慎重に調整しなければ上流のシステムの変更に追従できずデータが陳腐化したり，結合したパイプラインが破損したりしてしまう

## データメッシュ

## データメッシュの定義

-   データメッシュとは分析データを非中央集権的なやり方で共有，アクセス，管理するためのソシオテクニカルなアプローチ
-   データメッシュはレポート機能，機械学習モデルのトレーニング，インサイトの生成といった，幅広い分析ユースケースを満たす
-   実現の仕方は，データアーキテクチャやデータの所有権をビジネスドメインに一致させて，ぴあツーぴあなデータ開示を可能にすることで，これを実現する
-   データメッシュは次の 4 原則に基づいている

1. ドメイン主導のデータ所有権
    - データ所有者が共有し，いかなる仲介，中央管理されたデータレイクやデータウェアハウス，データ専門チームを必要とせずぴあツーぴあでデータにアクセスできるようにする
1. プロダクトとしてのデータ

    - 各ドメインが必要な組織的役割と，成功指標を持ち，組織全体のデータ利用者が喜ぶやり方でデータのを提供するという考え方
    - この原則は発見可能で理解可能で，タイムリーで安全で，高品質なデータをコンシューマーに提供するためのデータプロダクト量子と呼ばれる新しいアーキテクチャ量子の導入へとつながる

1. セルフサービス型のデータプラットフォーム
1. こんピューテーしょなるな連携型の統制
    - これはデータの所有権が分散しているにもかかわらず，データのコンプライアンス，セキュリティ，プライバシー，品質，データプロダクトの相互運用性など，組織全体の統制要件が全ての領域で一貫して満たされていることを保証する原則
    - データメッシュではドメインのデータプロダクトオーナーで構成される連携型の意思決定モデルを導入している
    - 策定されたポリシーは自動化され，コードとして各データプロダクトに埋め込まれる
    - このアプローチにおける統制へのアーキテクチャ的な意味合いはプラットフォームが提供するデータプロダクト漁師に組み込まれたサイドカーがデータの読み取りや書き込みといったアクセスポイントでポリシーを保存し，実行すること

## データプロダクト量子

-   データメッシュではサービスメッシュと同じようにサービスに隣接しながらも結合したデータプロダクト量子を構築する
-   ドメインにはコードとデータを含むデータプロダクト量子が含まれており，システム全体的な分析およびレポートのインターフェイスとして機能している
-   データプロダクト量子は運用上は独立しているが，高度に統合された振る舞いとデータのセットとして機能する
-   最近のアーキテクチャでは一般に次に示すような種類のデータプロダクト量子が存在する

    -   ソースアイランド

        -   強調するアーキテクチャ量子に代わって分析データを提供する

    -   集約データプロダクト量子
        -   複数の入力からデータを同期または非同期で集約する
        -   例えば非同期のリクエストで十分集約が可能な場合もあれば，ソースアイランドに対して同期クエリを実行する必要がある場合もある
    -   目的特化データプロダクト量子
        -   特定の要件に特化したデータプロダクト量子で，分析レポート，BI，機械学習などをサポートする機能を包含する

-   データプロダクト量子はサービスの実装を担当するドメインチームによって所有されるコンポーネントを表している
-   データプロダクト量子はデータベースに格納されている情報と重複しており，ドメインの動作の一部と非同期的に相互作用する可能性がある
-   また，データだけではなく，振る舞いが含まれている可能性もある

-   各データプロダクト量子はサービス向けの強調量子として機能する

### 強調量子

-   協調するサービスとは運用上分離している独立した量子
-   非同期通信と結果整合性によって協調サービスと通信する
-   強調サービスとは厳格なコントラクトによる密な結合を，レポートや分析，BI などを担うサービスである分析量子とは緩いコントラクトによる疎な結合持つ
-   強調サービスとデータプロダクト量子は運用上は独立している一方で，データの 2 つの側面(強調サービスは業務データ，データプロダクト量子は 分析データ)を表している

-   量子の動的結合の観点から，データサイドカーはつねに結果整合性と非同期の両方を備えた通信パターンであるパラレルサーガかアンソロジーサーガパターンのいずれかを実装する必要がある
-   言い換えればデータサイドカーには業務データと分析データを同期させるためのトランザクション要件を含めるべきではない

    -   それでは直交結合のためにデータプロダクト量子を使用する意味がなくなってしまう

-   同様にデータプレーンへの通信はドメインサービスの運用特性への影響を最小限に抑えるために非同期であるのが一般的
