# 13 コントラクト

-   アーキテクトの意思決定のほぼ全ての側面に影響を与える，ソフトウェアアーキテクチャに置ける不変の要素の一つにコントラクトがある
-   コントラクトとは講義には，アーキテクチャの異質な部分がどのように相互に接続されるのかをさす
-   ソフトウェアでは SOAP,REST,g RPC など多くのコントラクトフォーマットがソフトウェア開発における設計の一部になっている
-   この本では，定義をさらに広げ，アーキテクチャの部品が情報や依存関係を伝えるために使用するフォーマットとする

## 厳格なコントラクトと緩いコントラクト

-   厳格なコントラクトが好かれる理由として，内部メソッド呼び出しと同一の意味的な振る舞いをモデルかしているから
-   しかし，厳格なコントラクトは統合アーキテクチャに脆さをもたらすので避けなければいけない

    -   変更が頻繁なアーキテクチャに厳格なコントラクトを用いると，影響が大きい

-   REST や GraphQL は緩いらしい

    -   フィールドを追加しても，元々のものは壊れないから

-   アーキテクトが陥いるアンチパターンはいずれ他の情報も必要とするだろうと想定し，最初からそれらを全てのコントラクトのなかに組み込んでしまうこと
-   これはスタンプ結合の一例であり，必要のないところに破壊的変更を加えることになる，アーキテクチャを脆弱にするだけでなく，ほとんどメリットがないから
-   コントラクトを知る必要があるものの範囲に留めておくことで意味的結合と必要な情報のバランスをとり，統合アーキテクチャに不必要な脆弱性をもたらさないようにできる
-   緩いコントラクトを使用することで，マイクロサービスなどのアーキテクチャにおける目標の一つである極度に分離したシステムを実現できる
    -   コントラクトのゆるさにはコントラクトの確実性や，検証の欠如，アプリケーションロジックの増加などのトレードオフが伴う

## 厳格なコントラクトと緩いコントラクトのトレードオフ

### 厳格なコントラクトのメリット

-   コントラクトの忠実性の保証
-   バージョニング
-   ビルド時の検証が容易
-   優れたドキュメンテーション

### 厳格なコントラクトのデメリット

-   密結合
-   バージョニング
    -   廃止戦略などをしっかりしないと，あまりにも多くのバージョンを持つようになり，統合の悪夢となる可能性がある

### 緩いコントラクトのメリット

-   高度な分離
-   進化しやすさ

### 緩いコントラクトのデメリット

-   コントラクトの管理
-   適応度関数を必要とする

## マイクロサービスにおけるコントラクト

### コンシューマー駆動コントラクト

-   プッシュモデルをプルモデルに反転させたもの
-   コンシューマーがプロバイダーカラ取得したいアイテムをコントラクトとしてまとめ，プロバイダーに渡す
-   プロバイダーはビルド時にコントラクトを検証し，コントラクトが保証されたことを担保する
-   ここでいうコントラクトはコンシューマがプロバイダーから取得したい情報が指定されたもの
-   このような仕組みによりプロバイダーとコンシューマーからなるネットワーク内での協調が保たれる
-   コンシューマー駆動コントラクトでは，緩い結合と統制された結合という 2 つの問題を解決できるため，マイクロサービスアーキテクチャではよく用いられっる

### コンシューマー駆動コントラクトのメリット

-   コントラクトによるサービス間の緩い結合が可能

    -   名前と値のペアを使用することで，2 つのサービス間の結合は最も緩くなり，実装を変更しても壊れる可能性が最も低くなる

-   厳格さにばらつきを持てる

    -   チームがアーキテクチャ適応度関数を使用する場合，アーキテクトはスキーマや他の方付与ツールが提供する一般的な検証よりもより厳しい検証を行える
        -   数値型などの値範囲などを指定することができたりするから

-   進化可能

### コンシューマー駆動コントラクトのデメリット

-   成熟したエンジニアリングが必要

    -   アーキテクチャ適応度関数が真に機能するのは，よく訓練されたチームが優れた実践を行い，ステップを省略しない時だけ

-   一つではなく 2 つの仕組みの組み合わせ

## スタンプ結合

-   分散アーキテクチャでよくみられるパターンで，アンチパターンでもあるのが，スタンプ結合
    -   大きなデータ構造をサービス間で受け私するが，各サービスはデータ構造のごく一部しかやりとりしていないというもの

## スタンプ結合による過結合

## 帯域幅

## ワークフロー管理におけるスタンプ結合

-   スタンプ結合を使うと，サービス間のワークフロー状態を管理 s，ドメイン知識とワークフロー状態の両方をコントラクトの一部として渡すことが可能
-   ワークフローの管理にスタンプ結合を用いるとサービス間の結合どは通常よりも高くなってしまうが，意味的な結合はどこかでは行わなければいけないため，これオグラフィベースでワークフロー管理を解決するためにスタンプ結合を選択することは良いこと
