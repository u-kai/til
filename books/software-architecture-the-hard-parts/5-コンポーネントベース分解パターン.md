# コンポーネントベース分解パターン

## アーキテクチャストーリ

-   ユーザーストーリは実装や変更が必要な機能を記述する
-                                                                                                                                                                 アーキテクチャストーリーはアプリケーションの全体的な構造に影響を与え何らかのビジネス上の根拠を満たすリファクタリング内容を記述する
    -   スケーラビリティの向上や，市場投入時間の短縮など

## コンポーネントの特定及びサイズ調整パターン

-   モノリシックアプリケーションを移行する際にはまずコンポーネントの特定及びサイズ調整パターンから始める
-   このパターンの目的はアプリケーションのアーキテクチャコンポーネントを特定して一覧化し，コンポーネントのサイズを適切に決定することにある
-   コンポーネントのサイズを図るのは難しく，図るための便利なメトリクスとしてステートメント数がある
-   ステートメントとはソースコードないで実行される 1 つの完全なアクションを示し，{}などの特別な文字で区切られる
    -   これって結局関数とかメソッドとかではないのか？
    -   完全なアクションとは？
-   ステートメントは少なくとも，コンポーネントがどれだけの役割を果たしているのかどれだけ複雑なコンポーネントであるかを示す良い指標になる

-   アプリケーション内のコンポーネントのサイズが一定の水準であることは重要であり，一般にコンポーネントサイズの平均値から標準偏差 1~2 の間に収まるべき

## 収集すべき情報

### コンポーネント名

-   アプリケーションの図やドキュメント全体を通して，一貫性のあるコンポーネントの説明的な名前や識別子
-   コンポーネントの明確な役割と責任がすぐにわからない場合は，コンポーネント名をより説明的なものにすべき
-   本の例だと請求/支払い

### 名前空間

-   コンポーネントの物理的な識別子でそのコンポーネントを実装するソースファイルがグループ化され，保存されている場所を表す
-   この識別子は通常，名前空間，パッケージ構造，またはディレクトリ構造によって示される
-   本の例だと ss.billing.payment

### パーセント

-   コンポーネントの相対的なサイズをそのコンポーネントを含むソースコード全体閉めるパーセントで表したもの
-   この指標はそのコンポーネントを表すソースコードファイル内の総ステートメント数をアプリケーション全体の総ステートメント数で割ることで算出できる

### ステートメント数

-   そのコンポーネントに含まれる総ステートメント数

### ファイル数

-   ファイル数
-   適応度関数としては，パーセントが閾値より高いコンポーネントがある場合にアラートを出すようにする

## ドメイン共通コンポーネントの収集パターン

-   モノリシックアーキテクチャから分散アーキテクチャに移行する際は共通のサービスを簡単に特定，作成できるようにドメイン共通の機能を特定して統合するのが有益であることが多い

-   ドメイン共通コンポーネントの収集パターンは共通のドメインロジックを特定して収集し，コンポーネントにまとめるのに使用される

-   ドメインで共有される機能は，通知やデータのフォーマットやバリデーションのようなビジネス処理ロジックの一部であり，一部の処理で共有されるという点において基盤機能とは異なる
-   基盤機能とはログやメトリクスの収集，セキュリティといった運用的な性質を持つもので全てのプロセスに共通するもの
-   ドメイン共通機能の統合はモノリシックなシステムを分解する際に重複するサービスを排除するのに役に立つ
-   ごくわずかな違いは共通サービスにすることで簡単に解決できる
-   適応度関数として，異なるコンポーネントのコードツリー上に同じ名前がないのか検出する

-   ただし統合した後の影響を図ることは大事
    -   もし統合によって求心性結合度が高まる(依存度合が高まる)ならよくない

## コンポーネントのフラット化パターン

-   コンポーネントが他のコンポーネントの上に構築されるのではなく，フラット化され，ディレクトリ構造や名前空間のリーフノードとして表現されることを保証するために使用される

-   コンポーネントを名前空間，もしくはディレクトリ構造の最後のノードとして定義することで，コンポーネントをサービス化するときに一つにまとめるのか，独立させるのかの問題を解決する？？？
-   最後のノードの親はサブドメインであり，コンポーネントではないため，そこに直にファイルを置くべきでない

-   コンポーネントのフラットパターンは孤立したクラスを移動させて，ディレクトリや名前空間のリーフノードとしてのみ存在するように明確に定義されたコンポーネントを作成するために使用される
-   その過程では明確に定義されたサブドメインも作成される
-   コンポーネントのフラット化とは孤立クラスを削除するためにアプリケーション内の名前空間を分解することを指す
-   インターフェイスなどの共有コンポーネントが孤立したクラスとして置かれることがあるが，これは shared というコンポーネントに移動することで削除することができる

### 言葉の再定義

### コンポーネント

-   リーフノード名前空間内にグループ化されたクラスの集合
-   アプリケーション内の特定の機能(請求処理や顧客アンケート機能など)を実行する

### ルート名前空間

-   別の名前空間ノードによって拡張される名前空間ノード
-   例えば ss.survey と ss.survey.templates という名前空間がある場合，ss.survey は.templates によって拡張されているので，ルート名前空間と見なされる
-   サブドメインと呼ばれることもある

### 孤立クラス

-   ルート名前空間に含まれるクラス
-   従ってコンポーネントには関連づけられていない

## コンポーネントの依存関係判断パターン

-   このパターンの目的はコンポーネント間の入力と出力の依存関係を分析して，モノリシックアプリケーションを分割した後に生じるサービスの依存関係グラフがどのようになるのかを判断することにある

-   コンポーネントの依存関係はあるコンポーネントのクラスが別のコンポーネントのクラスと相互作用することで生じる
-   このパターンはコンポーネント内の依存関係ではなく，コンポーネント間の依存関係である

-   最後の例では，コンポーネント間の依存関係を確認しており，そこでは共有ライブラリへの依存はコンパイル時に検出できるから，コンポーネント間の依存として取り除いていた
    -   これはライブラリは静的な依存だからか，それとも，ライブラリの変更はサービスロジックの変更よりも少なく，影響が少ないからか？
    -   何となくぼやっとはわかるけど，うまく説明できる気はしない

## コンポーネントドメインの作成パターン

-   モノリシックアプリケーション内で特定された各コンポーネントはサービスの候補として考えられる
-   その一方で多くの場合，サービスとコンポーネントの関係は 1 対多となる
-   このパターンの目的は，コンポーネントを論理的にグループ化し，アプリケーションを分割する際により粗い粒度のドメインサービスを作成可能にすることにある
-   application.domain.subdomain.component.class のような名前空間になると良い
-   適応度関数として，ルート名前空間ノードの下の全ての名前空間はドメインのリストに制限されるべき
    -   つまり全てのコンポーネントは承認されたドメインの中にいるべきという感じかな？
-   開発チームが不注意で追加のドメインを作成するのを防ぎ，承認されたドメインのリストの外に新しい名前空間が作成された時にアラートを送信する

## ドメインサービスの作成パターン

-   コンポーネントが適切にサイズ調整され，フラット化され，ドメインにグループ化されたらそれらのドメインを個別にデプロイ可能なドメインサービスに移行できる
-   マイクロサービスではなく，サービスベースアーキテクチャへの移行を最初のステップとするのは，アーキテクトと開発チームが各ドメインサービスについての知見を深め，それらをマイクロサービスアーキテクチャスタイルのより小さなサービスに分割すべきか，大きなドメインサービスとして残すべきかを判断できるようになるという利点がある
-   最初からサービスを細かくしすぎると，本来であれば細かくする必要のなかったサービスに伴うマイクロサービスの付属物(データ分解，分散フロー，分散トランザクション，運用の自動化，コンテナ化)などを全て受け入れざるをなくなる
-   このパターン適用は，全てのコンポーネントドメインが特定され，リファクタリングし終えるまでは，このパターンは適用すべきではない，

    -   これにより，コンポーネントを移動する際の各ドメインサービスに対する修正量を削減できる

-   コンポーネントドメインをドメインサービスに移行し始めるのは全てのコンポーネントをコンポーネントドメインに整合させ，リファクタリングした後が良い

    -   境界をしっかり全て定義づけた後でやらないと，移行した後にやっぱり含めるべきだったコンポーネントなどが出てきて，修正量が多くなるって感じか？

-   適応度関数として，ドメインサービス内の全てのコンポーネントは同じ名前空間で始まるべき

## まとめ

移行作業が思いつきでうまくいくことはないので，上記のパターンを適用して，インクリメンタルな分解をすべき

これらのパターンを適用した後は必要に応じてモノリシックなデータを分解したり，ドメインサービスをより細かいマイクロサービスに分解したりできるようになる
