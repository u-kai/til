# 11 分散ワークフローの管理

## オーケストレーション通信スタイル

-   このパターンでは，オーケストレーター(メディエーター)コンポーネントを使用して，ワークフローの状態，オプションの動作，エラー処理，通知，その他のワークフローの維持に関わるものを管理する
-   マイクロサービスでは，全体のオーケストレーたではなく，ワークフローごとにオーケストレーターを用意する傾向がある
-   オーケストレーションは代替パスやエラー条件を含む複雑なワークフローをモデル化しなければいけない時に有効
-   メリット

    -   ワークフローの一元化
        -   複雑さが増すにつれ，状態と振る舞いが一つにまとめられたコンポーネントの存在が有益になる
    -   エラー処理

        -   オーケストレーターがワークフローの状態を所有することは，多くのドメインワークフローにおいて主要な部分であるエラー処理を円滑にする

    -   回復性

        -   オーケストレーターあ g ワークフローの状態を監視しているため，1 つまたは，複数のドメインサービスが短時間の停止に見舞われた場合に再思考するロジックを追加できる

    -   状態管理
        -   オーケストレーターを持つことで，ワークフローの状態を紹介でき，他のワークフローや他の一時的な状態のための場所を提供できる

-   デメリット

    -   応答性
        -   全ての通信がオーケストレーターを経由しなければいけないため，スループットのボトルネックとなり，応答性が損なわれる可能性がある
    -   耐障害性

        -   オーケストレーターが SPOF になる
        -   冗長化によって対処可能だが，システムはより複雑になってしまう

    -   スケーラビリティ
    -   サービス結合
        -   中央にオーケストレーターを置くことで，オーケストレーターとコンポーネントドメインとの間の結合度が高くなるものの，これが必要な場合もある

## コレオグラフィ通信スタイル

-   中央で調整を行わない通信スタイル
-   ワークフローの状態の所有者は存在しない
-   フロントコントローラーパターンでは，責任の連鎖の中で最初に呼び出されたサービスに状態の責任を追わせる
-   ステートレスコレオグラフィは一時的なワークフロー状態を全く維持せず，リアルタイムのスナップショットを構築するのに個々のサービスへクエリを用いる方法

    -   この方法では，最初のサービスの状態が単純化される一方で，ステートフルなスナップショットを構築するためにサービス同士が頻繁にやり取りするという点で，ネットワークのオーバーヘッドが大幅に増加する
    -   分離性は極めて高いが，複雑さが増してしまうよう

-   スタンプ結合はサービス間で送信されるメッセージコントラクトに追加のワークフロー状態を保存するという方法

    -   各ドメインサービスは全体的な状態の一部を更新し，その状態を責任の連鎖の次のドメインに渡す
    -   従って，そのコントラクトのコンシューマーは各サービスに問い合わせることなくワークフローの状態を確認できる

-   これコレオグラフィベースのメリット

    -   応答性

        -   オーケストレーターがないため，この通信スタイルではより多くの並列かの機会が得られる

    -   スケーラビリティ
        -   応答性と同様にオーケストレーターのような調整てんがないため，独立したスケーリングが可能になる
    -   耐障害性
        -   オーケストレーターがないため，複数のインスタンスを使用することで耐障害性を高められる
    -   サービス分離
        -   オーケストレーターがないため，結合が少なる

-   これコレオグラフィベースのデメリット

    -   分散ワークフロー

        -   ワークフローオーナーがないためエラー管理などの境界条件が難しくなる

    -   状態管理

        -   一元化された状態保持者がいないため，継続的な状態管理が困難になる

    -   エラー処理
        -   オーケストレーターがないと，ドメインサービスがより多くのワークフロー知識を持つ必要があり，エラー処理が難しくなる
    -   回復可能性
        -   オーケストレーターがないと，再思考やその他の修復作業を試みるため，回復が困難になる

## オーケストレーションとコレオグラフィのトレードオフ

## 状態の所有者と結合

-   応答性とスケーラビリティを必要として，複雑なエラーシナリオを持たないか頻度の低いワークフローがコレオグラフィのスイートスポットになる
-   一方，境界条件やエラー条件を含む複雑なワークフローにはオーケストレーションが最も適している
    -   このスタイルはコレオぐらふぃほどのスケーラビリティは持たない一方大抵は複雑を大幅に軽減する
