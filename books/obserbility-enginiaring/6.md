# イベントをトレースに繋ぐ

- 分散トレースは単に相互に慣例した一連のイベント
- 分散トレースシステムはこれらの関係を追従する作業を自動的に魔法のように作成し、それを管理するパッケージ化されたライブラリを提供する。

## 分散トレースとその重要性

- トレースとはソフトウェアデバッグの基本的な手法の一つで、プログラムの実行中に様々な情報を記録し、問題を診断することを目的としている
- 分散トレースとは 1 つのリクエストがアプリケーションを構成する様々なサービスによって処理される過程を追跡する方法
- オブザーバビリティがあるシステムにおいて、トレースは単に相互に接続された一連のイベント

## トレースの構成要素

- ボトルネックが発生している場所を素早く理解するためにトレースをウォーターフォール形式で視覚化することが便利

  - リクエストの各ステージはデバッグ中のリクエストの開始時刻と継続時間に関連した個別のチャンクとして表示される

- どんなに複雑な経路であってもその経路を表示するために各コンポーネントについて 5 つのデータが必要

  - トレース ID

    - 特定のリクエストにマッピングできるようにこれから作成するトレースには一意の識別子が必要
    - この ID はルートスパンによって作成され、リクエストが満たされるために取られる各ステップを通して伝播する

  - スパン ID
    - 作成された個々のスパンに対しても一意の識別子が必要
    - スパンには 1 つのトレースで作業単位が発生した際に取得した情報が含まれる
    - この一位な ID により、必要な時にいつでもこのスパンを参照できる

- 親 ID

  - トレースのライフサイクルを通じて入れ子関係を適切に定義するために使用される
  - ルートスパンには親 ID がない

- タイムスタンプ

  - 各スパンはその作業がいつ開始されたのかを示さなければいけない

- 継続時間

  - 各スパンはその作業が終了するまでにかかった時間を記録しなければいけない

- これら上記のフィールドはトレースの構造を組み立てるために絶対に必要なもの

- スパンを特定したり、スパンがシステムにどのように関連しているかを確認する際に他のいくつかのフィールドが役立つと思われる
- スパンに追加されるデータは基本的に一連のタグ
- いかがいくつかの例

  - サービス名
  - スパン名

- このデータがあれば、どのようなリクエストに対しても、問題を素早く診断するために必要なウォーターフォール型の可視化を構築できるはず

## トレースを地道に軽装する

- 分散トレースの主な目的はリクエストが複数のサービスを通過するのを追跡すること
- もし、2 つのサービスを呼び出すのであれば、そのリクエストには最低 3 つのスパンを捉えることが期待される
- 以下は例

  - 大元の rootHandler へのリクエスト
  - 認可サービスの呼び出し
  - ネームサービスの呼び出し

- 最初に一意のトレース ID を生成して、皇族のスパンを元のリクエストにグループ化できるようにする
- また、同じトレースないの異なるスパンを一つに関連づけるための識別子として使用できるスパン ID を生成する

```go
func rootHandler(...) {
    traceData := make(map[string]interface{})
    traceData["trace_id"] = uuid.String()
    traceData["span_id"] = uuid.String()
    ...
}
```

- また、このスパンがいつ始まり、どのくらいの時間で実行されたのかも知りたい
- スタートと終わりのタイムスタンプを取得して実現する
- そして service_name,span_name を説明フィールドとしてつける
- 最後に全てのデータをトレースバックエンドへ送信する
- この 1 つのトレーススパンのために必要なデータ要素は持っているが、このトレースデータをリクエストの一部として呼び出している他のサービスに中継する方法がまだない
- 少なくとも、トレースないのどのスパンなのか、このスパンがどの親に属しているのか、そしてそのデータはリクエストのライフサイクルを通して伝播される必要がある
- 分散型トレースシステムで情報を共有する最も一般的な方法はアウトバウンドリクエストの HTTP ヘッダーに情報を設定すること
- 今回の例ではヘルパー関数 callAuthService と callNameService を拡張して、traceData マップを受け取り、それを使用して送信リクエストに特別な HTTP ヘッダーを設定できる
- これらのヘッダーは受信側のプログラムが同じ名前を理解できる限り、どのようにでも呼ぶことができる
- 通常 HTTP ヘッダーは W3C や B3 のような特定の標準規格に従う
- 子スパンが正しくスパンを構築して送信できるように以下のヘッダーを送信する必要がある
  - X-B3-TraceId
    - トレース全体のトレース ID
  - X-B3-ParentSpanId
    - 現在のスパン ID を保持する
    - この ID は子プロセスで生成されるスパンの親 ID として設定される

## トレーススパンへのカスタムフィールドの追加

- 親子関係や、実行時間の把握は良いスタート
- 他のフィールドを追加して分散システムの奥深くに潜む各スパンで何が起きているのかをより理解することもできる
- OS とかホスト名スラも入れたらいいケースがあるみたいなので、この本ではそれをつっこんでいる
- 通常このコードを全て自分で生成する必要はない

## イベントをトレースに繋ぐ
