# OpenTelemetry を使った計装

## オープンな計装標準

- ベンダーロックインを避けるために OSs として、テレメトリーデータを収集してリアルタイムで好みのバックエンドに転送できるように人気のプログラミング言語用のライブラリセットをを提供した
- CNCF 参加の OpenTelemetry プロジェクトが発足した
- OpenTelemetry はトレース、メトリクス、ログ、およびその他のアプリケーションのテレメトリデータをキャプチャし、好みのバックエンドへの送信を可能にする
- OpenTelemetry はオブザーバビリティソリューションの中で application 計装をおこうあんための唯一のオープンソース標準となっている
- OpenTelemetry を使用すると、アプリケーションコードの計装を一度だけ行えばオープンソースかプロプライエタリかを問わず、テレメトリーデータを選択したバックエンドシステムに送信できるようになる

## コードベース例を用いた計装

## OpenTelemetry の概念を学ぶ

- OpenTelemetry はサービスからのテレメトリーデータを作成、管理するために設計されたライブラリ、エージェント、ツール、その他コンポーネントを提供する
- OpenTelemetry は異なるテレメトリーデータタイプの API をまとめ、それら全てに共通する分散コンテキストの伝播を管理する
- OpenTelemetry はそれぞれの前進プロジェクトからの概念とコンポーネントを組み合わせてそれらの利点を維持しながら以前に書かれた計装都の広報互換性を保っている

### 自動軽装から始める

- 分散トレースを採用する際の最大の課題のひとつは、システムに関してすでに持っている知識にマッピングできるような十分に有用なデータをえられるかどうか？
- 手動で各リクエストのトレーススパンを開始、終了することは可能だが、負担を減らし、数ヶ月ではなく、数時間、または数日で洞察を得るためのより良い方法がある
- そのために Otel は自動軽装を実施しており、ユーザーが最短の時間で最初の価値を得られるようにしている
- リクエストのプロパティとタイミングを計測する自動計装を提供するためにフレームワークはリクエストを処理する前後に Otel エージェントを呼び出す必要がある
- つまり、一般的なフレームワークに対してラッパーやインターセプター、もしくは Otel エージェントが自動的にコンテキスト伝播のメタデータを読み取り、各リクエストのスパンを作成するためにフックできるミドルウェアをサポートしている
- Go では明示的な堅安全性とコンパイル時の必要から、明示的にミドルウェアを設定する必要がある
- ラッパーのパターンについて Go では http.Request/http.Response HandlerFunc インターフェイスにが最小公倍数的に使われている
- HTTP サーバーのデフォルトのリクエストルーターに渡す前に otelhttp パッケージを使って既存の HTTP ハンドラー関数をラップできる

## まとめ

- Otel はオープンソースの標準規格で、選択した任意の数のバックエンドデータストアに対してテレメトリーデータを送信できるようになる
- どのようなシステムを選んでもアプリケーションからテレメトリーデータを発信できる
- 必要であればメトリクスのデータを入れることができるが、これがなぜ必要ならばという前置きがあるかというと、メトリクスは固有の制限を持つデータ型だから
