# Git のブランチについて

- git にはブランチというものがある
- ブランチの実態はコミットある一つのコミットを指すポインタ

```bash
git log

commit 14ec7b80acb29b6979d7249272304109c0991399 (HEAD -> main, origin/main) # mainとorigin/mainがブランチ名で，この例ではどちらも14ec7b80acb29b6979d7249272304109c0991399を指している
Author: Kai
Date:   Fri Sep 8 06:44:26 2023 +0900
```

- 実際は .git/regs/heads/ブランチ名のファイルに記述がある

  - リモートリポジトリに関する記述は .git/regs/remotes/origin(remote のエイリアス)/ブランチ名のファイルに記述がある

- ちなみに HEAD はいま現在いることを示すもので，
  - 上の図では main ブランチを指しているので，現在は main ブランチに存在しており，実際は 14c37b...というコミットを指している

```bash
cat .git/regs/heads/main
```

## ブランチは何の役に立つのか？

- 実はブランチはいくらでも作成可能

```bash
git branch ブランチ名
```

- branch は作成されると HEAD が指すコミットを指すポインタとして作成される
- 以下のコマンドで現在いるブランチを移動できる

```bash
git checkout ブランチ名
または
git switch ブランチ名
```

![](./dev-branch.png)

- このようにブランチを分けることで本命のブランチ(main ブランチであることが多い．一般的な名称としてトランクとも言われる)に影響を与えずに独立して開発ができる

  - バグを仕込んでも本命のブランチには影響がない

- ある程度ブランチで開発が進むと，本命のブランチにマージすることができる

```bash
git switch main

git merge ブランチ名
```

- このようにブランチを駆使して開発を進める考え方としてたくさんの git flow がある
  - GitHub Flow
  - GitLab Flow
  - Git Flow
  - ...

# トランクベース開発について

- 上ではブランチに分けて開発をすることで，本命のブランチに影響を与えずに開発を進めることができると述べた
- しかし，結局は本命のブランチ(トランク)にマージする必要があり，マージするときにはコンフリクトが発生する可能性がある
- また，ブランチを分けて，多くの変更を別のブランチで行った後にマージすると，コンフリクトする可能性が高くなるし，どこでコンフリクトが発生したのかもわかりにくくなる
- コンフリクトはせずに，内部にバグを持つこともあり，そっちの方が厄介

  - コンフリクトは悪いことがわかるのでまだ対処できる
  - コンフリクトせずにうまくいっていると思いきや，どこかしらで動かなくなると地獄
  - マージ前の多くのブランチで行った変更の中から原因を探すのは大変

- ブランチを分けることで分けられたブランチで多くの変更 をおこなってしまうことが原因
- そこで，トランクベース開発という考え方がある
- トランクベース開発とは，ブランチを分けずに，本命のブランチのみで開発を進めること
- トランクベース開発では，本命のブランチには常に動く状態を保つことが求められる

  - そのため，テストを自動化して，ブランチに push した際にテストを実行し，テストに失敗した場合は push を拒否するような仕組みが必要

- トランクベース開発をうまく行おうとすると，小さい変更を即座に本命のブランチに push するようになる
- そうすると，何かが悪くなってもすぐに気づけ，修正も簡単にできる
- 安全な統合ができるようになる
- ブランチを分けるやり方が有効なケースは，OSS などの不特定多数の人が開発に参加する場合
- これはブランチを分けないことには，不特定多数の人が本命のブランチを変更できてしまい，本命のブランチが壊れてしまうから
- OSS の所有者は本命のブランチをリモートリポジトリの機能を使って誰でも変更できないよう保護して，ブランチを分けて開発を進める
- 統合しても良いと評価したブランチからの変更のみを本命のブランチにマージする
