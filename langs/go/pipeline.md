# Pipeline

- パイプラインはデータを受け取って，何らかの処理を行ってどこかに渡すという一連の作業
- これらの操作をパイプラインのステージと呼ぶ
- パイプラインを使うことで，各ステージでの懸念事項を切り分けられる

  - 利点
    - 各ステージを独立して修正することができる
    - ステージ同士の組み合わせ方をステージの修正とは独立して変更できる
    - 各ステージでの処理を上流や下流のステージと並行に行える
    - パイプラインでの細かな処理をファンアウトさせたり，流量制限かけたりできる

- パイプラインのステージの性質

  - ステージは受け取るものと返すものが同じ型
  - ステージは引き回せるように具体化されてなくてはならない

- チャネルはパイプラインを構築する上で Go ならではの姿に適合している
- なぜならチャネルはパイプラインの構築に必要な要件を全て備えているから

  - 値を送受信可能なところ
  - 並行処理で安全に使えて繰り返し処理で取り出せて，言語によって具体化されている

- 個別の値の塊をチャネル上を流れるデータのストリームに変換してくれるものをジェネレーターと呼ぶ

  - パイプラインを使う場合はよく見かける
  - その理由はパイプラインの初めには常にチャネルへの変換を必要とするデータの塊があるから

- 空インターフェイス型は Go では一種のタブーとされているが，パイプラインステージについてはいいのではないかという本の意見
  - 再利用可能なステージによって多くのパイプラインの利便性が得られ，再利用性が最も達成されるのは，ステージ自身に見合った度合いで処理が特化されている場合
  - ジェネレーターでは，関心ごとはリストや処理をくり返してデータのストリームを生成すること
  - 結局これは Generic がないからこうなるのかな
    - やっぱりトレイと境界は相当強力な記述な気がする

## ファンアウト，ファンイン

- ファンアウトはパイプラインからの入力を扱うために複数のごルーチンを起動するプロセスを説明するための用語
- ファンいんは複数の結果を 1 つのチャネルに結合するプロセスを説明する用語
- パイプラインのステージでこのパターンを使うべき状況は次の条件 2 つに一致するもの
  - そのステージがより前の計算結果に依存していない
    - この点は重要で，どのステージが並行処理になっているのか，ステージがどの順番で実行されるか，どの順番で値が返されるのかに何の保証もないから
  - 実行が長時間に及ぶ

## キュー

- キューを導入することの利点は，ステージの実行時間が減るのではなく，ステージがブロック状態になっている時間が短くなること
  - リクエストを受け付けて次のステージに写すステージが，次のステージによってずっとブロックされているとリクエストを受け付けることができないので，キューをかまして，リクエストを受け付けることを可能にする
  - ただし，そのリクエストの処理完了の時間短縮にはならない
- キューが役に立つのは以下の 2 つのパターン
  - ステージ内でのバッチによるリクエストが時間を節約する場合
  - ステージにおける遅延がシステムにフィードバックループを発生させる場合

### チャンキング

- 通常オーバヘッドを必要とする処理を行うときはいつでもチェンキングはシステムの性能を向上させる
- キューは次のでどちらかで実装されるべき

  - パイプラインの入り口
  - バッチ処理によって効率的になるステージの中

- キューをどこにでも，例えば計算コストが高いステージの後など，に置きたくなる誘惑に駆られるかもしれないが，その誘惑を断ち切ること
- キューがパイプラインの実行時間を減らせるのはたかだか 2，3 の状況しかない
- そして回避策としてキューをそこらじゅうに書いてしまうと悲惨な目に遭う
