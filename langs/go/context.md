# context パッケージ

- done チャネルに，単純なキャンセル通知に付随して追加の情報も伝達できると便利
- 例えばキャンセルが発生した理由や，関数の処理を終わらせるべきデッドラインがあるかなど
- このような done チャネルに情報を含めて囲む需要はどのような規模のシステムにおいても非常によくあることがわかり，Go の作者たちはその標準的なパターンを作ることに決定した
- Context 型は done チャネルのようにシステム内を流れる

  - context パッケージを使う場合には並行処理の呼び出しもとの最上位より下流の各関数は Context を第一引数として受け取る

- Context は interface で次のような定義

```go
type Context interface {
    // 一定の時刻以降にごルーチンがキャンセルされるかどうかを返す
    Deadline()(deadline time.Time,ok bool)
    Done()<- chan struct{}
    // ごルーチンがキャンセルされたら非nilな値を返す
    Err()error
    Value(key interface{})interface{}
}
```

- context パッケージには 2 つの目的がある

  - コールグラフの各枝をキャンセルする API を提供する
  - コールグラフを通じてリクエストに関するデータを渡すデータの置き場所を提供する

- 関数内でのキャンセルは 3 つの側面がある

  - ごルーチンの親がキャンセルをしたい場合
  - ごルーチンの子供がキャンセルをしたい場合
  - ごルーチン内のブロックしている処理がキャンセルされるように中断できる必要がある場合

- コンテキストは型安全を担保できないのが弱点の一つ
- コンテキスト値はプロセスや API の境界に通過するリクエストスコープでのデータに絞って使うべし
- 関数にオプションのパラメータを渡すために使われるべきではない

- リクエストスコープとは(本の著者の記述)

  - データはプロセスや API の境界を通過すべし

    - プロセス内のメモリでデータを生成したのなら，そのデータはリクエススコープのデータではない
    - ただしそのデータを API の境界も超えて渡す場合は除く

  - データは普遍であるべき
    - もし不変でないのであれば，定義により保管しようとしているデータはリクエストから来たものではない
  - データは単純な型に向かっていくべし
    - リクエストスコープのデータがプロセスや API の境界を通過することを意図されていて，複雑なパッケージのインポート関係を必要としなければ，通過した先にいる側がこのデータをずっと簡単に取得できるはず
  - データはデータであるべきで，メソッド付きの方であるべきでない
    - ロジックはデータを消費する物に属している
  - データは就職の操作を助けるべきものであってそれを駆動するものではない
    - 自分のアルゴリズムが Context に含まれるものによって異なった振る舞いをするのであればオプションのパラーメータが扱うべき領域を犯してしまっている

- Context が上の 5 つを破っている場合は考慮する必要がある
