# L2TP(Layer 2 Tunneling Protocol)

- データリンク層の PPP フレームをトンネリングする技術
- L2TP は UDP の上位層として規格化されており，IP ネットワーク内を通信できる
- PPP は専用線などで結ばれた 2 点間の通信に用いられるデータリンク層のプロトコル
- L2TP は専用線を仮想的に生成する技術
  - つまり，IP のネットワークの上に専用線の役割を果たすトンネルを設けることで 2 点間の PPP の通信を実現しているもの
- もし PPP 通信を行いたい 2 点間がインターネットで接続していた場合(L2TP 通信がインターネットを介して行われていた場合)L2TP 区間を暗号化する必要がある
- そのために用いられるのが L2TP over IPsec

## L2TP over IPsec

- トンネリングに L2TP を使い，トンネル区間の暗号化に IPsec を用いる技術
- リモートアクセスによる VPN 通信でよく使われる
- リモートアクセス端末から宛先にリモートアクセスする際，以下の 4 手順を踏む
  - リモートアクセス端末の利用者は VPN サーバに接続する
    - このときまず IPsec による接続が確立される
    - その次に L2TP トンネルが確立される
  - VPN サーバは利用者認証を行う
    - PPP の機能を利用して VPN サーバによる利用者認証を行う
      - PPP が備えているパスワード認証方式である CHAP などが用いられる
  - VPN サーバはプライベート IP アドレスの払い出しを行う
    - PPP の機能を利用した VPN サーバによる IP アドレスの払い出し
    - 割り当て用の IP アドレスの範囲は VPN サーバにあらかじめプールしておく
    - VPN 接続用ソフトはプライベート IP をリモートアクセス端末の仮想 NIC に割り当てる
  - リモートアクセス端末の利用者は宛先に接続する
    - 上記で割り当てられたプライベート IP で接続する
- 上記手順の上 2 つは PPP よって提供されている

  - この機能を利用して VPN 通信を行いたい場合は IP パケットを PPP フレームでカプセル化しないといけない
  - この PPP フレームをインターネットを介して流したいので L2TP でカプセル化している
  - さらにこれを暗号化したいので ESP を使った IPsec をしている

- VPN クライアントソフトには仮想的な NIC を持つことが可能

  - 送信もと端末から見ると仮想 NIC が LAN-B に接続されているように見える

- L2TP のトンネル区間はと IPsec のカプセル化区間はゲートウェイ間
- リモートアクセス端末の仮想 NIC から宛先にオリジナル IP パケットが送信されると，リモートアクセス端末のゲートウェイはこれをまず PPP でカプセル化し，次いで L2TP でカプセル化し，最後に IPsec でカプセル化する
- 受信側ではカプセル化を解除し，オリジナル IP パケットを宛先として転送する
- IPsec でカプセル化するときはトランスポートモードを使う
- L2TP パケットは IP ヘッダを有し，すでに L2TP でトンネリングしているため IPsec で再度トンネリングする必要がないから
