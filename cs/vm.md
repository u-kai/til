---
marp: true
---

# 仮想化機能について

---

# 仮想化機能とは

- PC やサーバーなどの物理的なマシン上で仮想マシンを動かすためのソフトウェア機能，およびそれを助けるハードウェア機能の組み合わせ

---

# 仮想化機能の用途

- ハードウェアの有効活用
  - IaaS
- サーバの統合
- レガシーシステムの延命
  - ハードウェアサポートが終わった古いシステムを仮想マシン上で動かす
- ある OS 上で別の OS を動かす
- 開発／テスト環境
  - 業務システム環境と同じ，または似た環境を物理マシンなしに構築する

---

# 仮想化ソフトウェア

- 仮想マシンは物理マシン上に存在する仮想化ソフトウェアが生成，管理および破棄をする
- 仮想化ソフトウェアは物理マシン上のハードウェア資源を管理し，それを仮想マシンに分配する
- この時物理マシン上の CPU を物理 CPU，仮想マシン上の CPU を仮想 CPU とよぶ
- 仮想化ソフトウェアと仮想マシンとの関係はカーネルのプロセス管理システムとプロセスの関係によく似ている

---

# 仮想化の種類

- 仮想化ソフトウェアの実現には様々な方法がある
- 例えば物理ハードウェアの上に直接ハイパーバイザーと呼ばれる仮想化ソフトウェアをインストールするもの，既存 OS の上のアプリケーションとして動かすものなど
- VMware 社の商品
- Oracle 社の VirtualBox
- Microsoft 社の Hyper-V
- などがある

---

# 仮想化を支援する CPU の機能

- CPU がプロセスを動作させている時はユーザーモード
- システムコールや割り込みの発生をきっかけとしてカーネルが動作するときにはカーネルモード
- 仮想化機能をサポートしている CPU ではこの考え方を拡張している

  - 具体的には物理マシンの処理をしているときのために VMX-root というモードが，仮想マシンの処理をしているときのために VMX-nonroot というモードがある
  - 仮想マシンの処理をしているときにハードウェアへのアクセスや物理マシンへの割り込みが発生すると CPU が VMX-root モードに戻り，物理マシンへと制御が自動的に移る

- 疑問
  - ってことは CPU は仮想マシンにも物理マシンにも利用されるってことかな？

---

#　仮想マシンとメモリ管理

- 物理マシン上のメモリにはカーネルのメモリやプロセスのメモリが共存している
- 仮想マシンのメモリもその中の 1 つ
- 具体的には qemu-system-x86_64 プロセスのメモリとして存在する
- このプロセスのメモリはさらに仮想マシン管理用メモリと仮想マシンそのもに与えられるメモリの 2 つに分けることができる
  - 前者はハードウェアエミュレーション処理のためのコードやデータ
  - 後者の内訳は仮想マシン内のカーネルやプロセスのメモリ

---

# 仮想マシンとストレージデバイス

- 仮想マシン上のストレージデバイスは物理マシン上ではファイル，あるいはストレージデバイスと関連づけられている
- 仮想マシンがストレージデバイスまでに書き込むには多くの層を経由するため性能が著しく落ちる
- また，物理マシン上で仮想ディスクイメージはその他のファイルとファイルシステムを共有している
  - 従ってゲスト OS のストレージ I/O 性能はディスクイメージが存在するファイルシステムへの他の I/O に影響を受ける
  - また実際に影響を受けたときには原因究明のためにホスト OS を調査する必要がある
  - このようなことを避けるために，ファイルではなく，1 つのストレージデバイスを丸ごと仮想ディスクイメージとすることがある
