---
marp: true
---

# ファイルシステム

---

- ファイルシステムが存在しない場合，データをディスク上のどの位置に保存するのか自分で決めなくてはならない
- そのときに他のデータを壊さないために空き領域の管理をしなくてはいけない
- さらに一旦書き込んだ後に読み出すために，どの位置にどのくらいのサイズどのようなデータが配置しているかも覚えていないといけない
- ファイルシステムは上の仕事を代行してくれる
- ファイルシステムはユーザーにとって意味のある一塊のデータをファイルという単位で管理する
- それぞれのデータがどこにあるのかはユーザが管理しなくてもストレージデバイス上の管理領域に保存している

---

- ファイルシステムにはデータとメタデータという 2 種類のデータがある
- データは実際の中身で，メタデータはファイルを管理するためにファイルシステム上に存在する負荷的な情報
- ファイル名
- ストレージデバイス上の位置やサイズ
- ファイルの種類
  - 通常のファイルか，ディレクトリか，デバイスファイルかなど
- ファイルの時刻情報
  - 作成した日時，最後にアクセスした日時，最後に内容を変更した日時
- ファイルの権限情報
  - どのユーザーがファイルにアクセスできるか
- ディレクトリのデータ

---

# ファイルへのアクセス方法

- ファイルシステム操作用の関数を呼び出すと，次のような順番で処理が進む

1. ファイルシステム操作用の関数が内部的にファイルシステム操作をするシステムコールを呼ぶ
1. カーネル内の仮想ファイルシステム(VFS)という処理が動作し，そこから個々のファイルシステムの処理を呼ぶ
1. ファイルシステムの処理がデバイスドライバを呼ぶ
1. デバイスドライバがデバイスを処理する

---

# メモリマップトファイル

- Linux にはファイルの領域を仮想アドレス空間上にマップするメモリマップトファイルという機能がある
- mmap()関数を所定の方法で呼び出すことで，ファイルの内容をメモリに読み出して，その領域を仮想アドレス空間にマップできる
- メモリマップしたファイルにはメモリと同じ方法でアクセスでき，データを変更した場合，のちほどストレージデバイス上のファイルに所定のタイミングで書き戻す

---

# 一般的なファイルシステム

- Linux では ext4,XFS,Btrfs などのファイルシステムが使われている
  - ext4
    - Linux で最もよく使われているファイルシステム
  - XFS
    - スケーラビリティに優れたファイルシステム
  - Btrfs
  - 機能が豊富

---

# ファイルシステムの違い

- ストレージデバイス常に作るデータ構造，およびそれを扱うための処理が異なる
  - ファイルシステムの最大サイズ
  - ファイルの最大サイズ
  - 最大ファイル数
  - ファイル名の最大長
  - 各処理の処理速度
  - 標準によって佐だめられていない追加機能の有無

---

# 容量制限(クォータ)

- システムを複数の用途で使っている場合，ある用途についてファイルシステムの容量を無制限に使えると，他の用途に使うための容量が足りなくなることがある
- この問題を避けるために用途ごとに使用できるファイルシステムの容量を制限する機能がある
- この機能はクォータと呼ばれる
- ユーザクォータ
  - ファイルの所有者となるユーザーごとに容量を制限
- ディレクトリクォーター
  - 特定のディレクトリごとに容量を制限
- サブボリュームクォータ
  - ファイルシステム内のサブボリュームという単位ごとに溶炉用を制限
  - 概ねディレクトリクォータと使い方は同じ
- 業務システムにおいてはクォータ設定により，特定のユーザーやプログラムがストレージ容量を使いすぎないように制限することがよくある

---

# ファイルシステムの整合性保持

- ファイルシステムのデータをストレージに読み書きしている最中に電源が落ちるなどの，ファイルシステムの不整合が生じることがある
- ジャーナリングとコピーオンライトが広く使われているファイルシステムの不整合防止策

---

# ジャーナリングによる不整合の防止

- ジャーナリングではファイルシステム内にジャーナル領域という特殊なメタデータ領域を用意する
- このときファイルシステムの更新は以下のようになる

  - 更新に必要なアトミックな処理の一覧を一旦ジャーナル領域に書き出す
    - この一覧をジャーナルログと呼ぶ
  - ジャーナル領域の内容に基づいて，実際のファイルシステムの内容を更新する

- ジャーナルログの更新中に電源断が発生した場合，単にジャーナルログを捨てるだけで実データは処理前の状態と変わらない
- 実データの更新中にで電源断が発生した場合，ジャーナルログに基づいて実データを更新する

---

# コピーオンライトによる不整合防止

- ext4 や XFS などは，一旦ストレージデバイス常にファイルのデータを書き込んだらその後ファイルを更新すると，ストレージデバイス上の同じ位置にデータを書き込む
- その一方で Btrfs などのコピーオンライト型のファイルシステムは一旦ファイルにデータを書き込んだ後は，更新するごとに別の場所にデータを書き込む
  - 更新後のデータを別の場所に全て書き込んでからリンクを貼り替えるという挙動をする
- 電源断が起きても再起動後に作りかけのデータを削除すれば不整合は発生しない

---

# Btrfs が提供するファイルシステムの高度な機能

- ext4 や XFS は細かな違いはあるものの，機能面では Linux の元になる UNIX が作られた頃からある基本的なものだけを提供している
- その一方で Btrfs はこれらにはない機能がある

---

# スナップショット

- Btrfs はファイルシステムのスナップショットを採取できる
  - スナップショットの作成はデータのフルコピーではなく，データを参照するメタデータの作成だけで住むために通常のコピー操作よりもはるかに高速
- スナップショットは採取元のファイルシステムとデータを共有しているため，共有しているデータが何らかの理由によって壊れた場合は，スナップショットのデータも壊れる

  - このためスナップショットはバックアップとしては機能しない

- ファイルシステムレベルでバックアップを採取する場合は一般的にファイルシステムへの I/O を止める必要があるが，スナップショットを使えばその時間を短縮できる
  - 具体的にはスナップショットを採取する短い時間だけ I/O を止めて，その後はスナップショットのバックアップを取ればファイルシステム本体の I/O は止めなくて済む

---

# メモリベースのファイルシステム

- ストレージデバイスの代わりにメモリ上に作成する tmpfs というファイルシステムがある
- このファイルシステムに保存したデータは電源を切ると無くなってしまうが，ストレージデバイスへのアクセスが一切発生しないため高速にアクセスできる

---

# ネットワークファイルシステム

- ネットワークを介してつながっているリモートホスト上のデータにファイルシステムのインターフェイスを使ってアクセスするネットワークファイルシステムというものがある
- NFS や CIFS などがある

---

# procfs

- システムに存在するプロセスについての情報を得るために procfs というファイルシステムが存在する
- procfs は/proc 以下にマウントされている
- /proc/pid 以下には pid で指定したプロセスの情報がファイルとして存在する
  - /proc/$pid/maps
    - プロセスのメモリマップ
  - /proc/$pid/cmdline
    - プロセスのコマンドライン引数
  - /proc/$pid/stat
    - プロセスの状態
    - これまでに使用した CPU 時間，優先度，使用メモリ量など

---

# sysfs

- Linux において procfs が導入されてからしばらく経つと、プロセスに関するもの以外のカーネルが保持する雑多な情報が、procfs に際限なく置かれるようになった
  - procfs のさらなる濫用を防ぐために、これらの情報を配置する場所として作られたのが sysfs
