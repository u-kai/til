---
marp: true
---

# ブロック層

---

# ブロック層とは

- ブロックデバイス(ストレージデバイス)の性能を引き出すためのブロック層というカーネルの機能

---

# HDD の特徴

- HDD はデータを磁気情報で表現して，それをプラッタと呼ばれる磁気ディスクに記憶するストレージデバイス
- データはバイト単位ではなく 512B あるいは 4KiB のセクタと呼ばれる単位で読み書きする
- 図を載せる
- 磁気ヘッドという部品によってセクタ上のデータを読み書きしている
- HDD からのデータ転送の流れは次のとおり
  1. デバイスドライバがデータの読み書きに必要な情報を HDD に渡す
     - セクタ番号，セクタ数，およびアクセスの種類など
  1. スイングアームやプラッタを動かして目的のセクタ上に磁気ヘッドの位置を合わせる
  1. データを読み書きする

---

- 図を載せる

---

- HDD へのアクセスは機器的処理を含むため遅い
- 少しでも早くするために各種ファイルシステムは各ファイルのデータをなるべく連続した領域に配置するようにしている
- また，作成するプログラムも次のような工夫をすると I/O 性能の向上に寄与する
  - ファイル内の同時にアクセスするデータをなるべく連続する，あるいは近い領域に配置する
  - 連続する領域へのアクセスは複数回に分けずにひとまとめにする

---

# ブロック層の基本機能

- ブロックそうの基本機能は HDD の特徴を意識して作られている

  - 代表的な機能は I/O スケジューラと readahead(先読み)

---

# I/O スケジューラ

- I/O スケジューラはブロックデバイスへのアクセス要求を一定期間貯めておいて，次のような最適化処理をしてからデバイスドライバに I/O 要求を発行する
  - マージ
    - 複数の連続するセクタへの I/O 要求を一つにまとめる
  - ソート
    - 複数の不連続なセクタへの I/O 要求をセクタ番号順に並べ替える

---

# readahead

- ブロックデバイス内のある領域を読み出した時に近い将来に後続の領域にアクセスする可能性が高いと推測して後続領域を先読みしてページキャッシュに保存しておく機能
- readahead は特にブロックデバイスへのアクセスパターンがシーケンシャルアクセス中心の場合に性能向上が期待できる
- readahead は無条件に発生するのではなく，ブロックデバイスへのアクセスがランダムアクセス中心だと分かれば先読みする範囲を短くすることがあるし，全く先読みしなくなることもある

---

# 性能指標

- スループット
  - 単位時間あたりのデータ転送量
- レイテンシ
  - 1 回あたりの I/O に要する時間
- IOPS
  - I/O per second の略で，1 秒間に処理できる I/O の数
