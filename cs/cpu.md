# CPU 詳細

- CPU の内部はレジスタ，制御装置，演算装置，クロックの 4 つの要素から構成されている
- CPU は，メモリから命令を取り出し，それを実行する
- レジスタはプログラムの中で意識することが多い
  - なぜならプログラムはレジスタを対象として記述されるから

```asm
mov eax, dword ptr [ebp-8] ;メモリーからeaxに値をコピーする
add eax, dword ptr [ebp-0Ch];eaxの値とメモリーの値を加算する
mov dword ptr [ebp-4], eax;eaxの値をメモリーに格納する
```

- eax,ebp はレジスタを表しており，メモリはアドレスで指すが，レジスタは名前で指す

- レジスタに格納される値は命令を表している場合と，データを表している場合がある
  - データは
    - 演算に使われる値
    - メモリーアドレスを表す値の 2 種類がある
- 値の種類によってそれを格納するレジスタの種類が異なる
- CPU の中にあるレジスタには個々に役割が異なる
  - 演算に使う値はアキュムレーター
  - メモリーのアドレスを表す値はベースレジスタやインデックスレジスタ
  - eax はアキュムレーター，ebp はベースレジスタ

## 実行されるまで

- OS はプログラムをハードディスクからメモリーにコピーした後で，レジスタの一つであるプログラムカウンタを最初の命令が格納されているアドレスに設定する
  - これによってプログラムの実行が開始される
  - CPU が 1 つの命令を実行すると，プログラムカウンタの値が自動的に 1 つ増加する
    - ただし，複数のメモリーアドレスを占める命令を実行した場合は，プログラムカウンタの値が命令サイズ分だけ増加する
  - CPU の制御装置はプログラムカウンタの値を参照してメモリーから命令を読み出して実行する

## 主なレジスタ

- プログラムカウンタ
- フラグレジスタ
  - if の結果や繰り返しが終了するかどうかのチェック，値がオーバーフローしているかどうかなどの判断を伴うような結果が格納されている
- アキュムレーター
  - 主に演算結果を格納するレジスタ
- ベースレジスタ
- インデックスレジスタ
  - ベースレジスタで配列データの最初のアドレスを保持しておく
  - そしてインデックスレジスタで配列の要素番号を指し示して上のベースレジスタに足し込めば目的の要素にアクセスすることができる
- 汎用レジスタ

  - 様々な値を格納するレジスタ
  - アキュムレーターに加えて演算結果を格納することも,フラグ値を入れることもある
    - ここがどのように利用されるかはプログラムの最適化によって異なるはず

- プログラムカウンタ，アキュムレーター，フラグレジスタ，命令レジスタ，スタックレジスタは基本的に一つ
- それ以外のレジスタは複数あることが多い

## CPU にできること(コンピュータにできる最小単位)

- マシン語命令が CPU にできる全てのことで，これがコンピュターに命令できる最小単位の命令
- 複雑なソフトウェアも実行される際はこの最小単位の CPU の動作を合わせられることによって実行されている
- 主に単純化したマシン語の命令の種類は以下
  - データ転送命令
    - レジスタとメモリー，メモリーとメモリー，レジスタと周辺装置の間でデータの読み書きをする
  - 演算命令
    - アキュムレーターで算術演算，論理演算，比較演算，シフト演算を行う
  - ジャンプ命令
    - 条件分岐，繰り返し，無条件のジャンプを行う
  - コール/リターン命令
    - 関数を呼び出す／呼び出し元に戻る

## スタック

- スタックは一時的に使われるデータが格納される領域で push 命令と pop 命令でデータの格納と読み出しを行う
- CPU アーキテクチャが取り入れることができるサイズが決まっている
- push 命令と pop 命令にはオペランドが 1 つしかない
  - このオペランドは何をプッシュまたは何にポップするかを表すもので，何番地のメモリーアドレスにプッシュまたはポップするかを指定するオペランドは不要
  - これはスタックにデータをお y み描きするメモリーアドレスを esp レジスタが管理してくれているから
- push 命令や pop 命令を実行すると自動的に esp レジスタの値が更新(push 命令では-4,pop 命令では+4)されるためプログラマはメモリーアドレスを気にする必要がない

## ハードウェアを制御する方法

- ハードウェアとの入出力を支えるのは IN 命令と OUT 命令
- IN 命令は指定したポート番号のポートからデータを入力し，それを CPU 内部のレジスタに格納する
- OUT 命令は CPU のレジスタに格納されているデータを指定したポート番号のポートに出力する
- コンピュータ本体にはディスプレイやキーボードなどの周辺装置を接続するためのコネクタがついている

  - それぞれのコネクタの奥にはコンピュータ本体と周辺装置の電気的特性を相互に変換する IC が接続されている
  - これらの IC を I/O コントローラと総称する
  - 電圧の違いやデジタルとアナログなどの電気的特性の違いがあるため，コンピュータ本体と周辺装置を直接接続することはできないので I/O コントローラが必要になっている

- 機器それぞれに I/O コントローラがあり，コントローラの中にはポートがあり，これはメモリみたいな役割
- I/O コントローラの内部のメモリーをレジスタと呼ぶこともある
  - このレジスタは CPU 内部の物とは異なり，データを一時的に格納するだけのもの

## 割り込みコントローラ

- ハードウェアからの割り込みを制御する物で，I/O コントローラと CPU の間にいる
- 割り込み要求が発生したらそれを割り込み番号とともに CPU に伝える
- CPU はそれを解釈して，まず今のレジスタを退避したのちに割り込みハンドラを割り込み番号から呼び出し，実行する
- そして割り込みの処理が終了したらレジスタを復帰して本来の処理に戻る
