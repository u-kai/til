---
marp: true
---

# メモリ管理システム

---

# メモリの回収処理

- システムの負荷が高まってくるとメモリが少なくなることが多い
- カーネルのメモリ管理システムはこのような時回収可能なメモリ領域を開放する
- 回収可能なメモリの例としては，ディスクからデータを読み出してからまだ変更していないページキャッシュ
  - このようなページキャッシュは同じデータがディスク上に存在するので回収しても構わない

---

# プロセスの削除によるメモリの強制回収

- 回収可能なメモリを回収してもメモリ不足が解消されない場合，システムは何をするにもメモリが足りずに身動きがとれない Out of Memory(OOM)という状態になる
- メモリ管理システムにはこのようなときに，適当なプロセスを強制終了させることによって空きメモリを作る OOM killer という機能がある

---

# 仮想記憶

- メモリ管理において欠かせない機能が仮想記憶
- 仮想記憶はハードウェアとソフトウェア(カーネル)の連携によって実現している

---

# 仮想記憶がない時の課題

- メモリの断片化
- マルチプロセスの実現が困難
- 不正な領域へのアクセス

---

# メモリの断片化

- プロセスが生成された後にメモリの獲得，解放を繰り返すと，メモリの断片化が起きる
- プログラムはメモリ確保のたびに得られたメモリが何個の領域にまたがっているかを意識して使わなければならないので非常に不便
- サイズが大きい配列のようなデータは連続したメモリが必要になるので，断片化していると不便

---

# マルチプロセスの実現が困難

- 実行したプロセスと，その後に実行したプロセスが同じアドレスにマップされることを期待しているとかぶるため困難
- 複数プログラムを動かそうとするとユーザーが全プログラムの配置場所が重ならないように意識する必要が出てくる

---

# 不正な領域へのアクセス

- カーネルやたくさんのプロセスがメモリ上に配置されている場合，あるプロセスがカーネルや他のプロセスに割り当てられたメモリのアドレスを指定すれば，それらの領域にアクセスできてしまう

---

# 仮想記憶の機能

- 仮想記憶はプロセスがメモリアクセスする際に，システムに搭載されているメモリに直接アクセスさせるのではなく，仮想アドレスというアドレスを用いて，間接的にアクセスさせるという機能
- 仮想アドレスに対してシステムに搭載されているメモリの実際のアドレスを物理アドレスと呼ぶ
- またアドレスによってアクセス可能な範囲をアドレス空間と呼ぶ
- プロセスから実際のメモリ(物理アドレス)に直接アクセスする方法はない

---

# ページテーブル

- 仮想アドレスから物理アドレスへの変換にはカーネルのメモリ内に保存されているページテーブルという表を用いる
- CPU は全てのメモリをページという単位で区切って管理しており，アドレスはページ単位で変換される
- ページテーブル中の 1 つのページに対応するデータをページテーブルエントリと呼ぶ
- ページテーブルエントリには仮想アドレスと物理アドレスの対応情報が入っている

---

| 仮想アドレス | 物理アドレス |
| ------------ | ------------ |
| 0~100        | 500~600      |
| 100~200      | 600~700      |
| 200~300      | 700~800      |

- ページテーブルを作るのはカーネル
- カーネルはプロセス生成時にプロセスのメモリを確保して，そこに実行ファイルの内容をコピーする
- このときに同時にプロセス用のページテーブルも作る
- ただし，プロセスが仮想アドレスにアクセスした際に物理アドレスに変換するのは CPU の仕事
- カーネルがページテーブルの物理アドレスのやつをしっかり他プロセスと被らんようにしてくれているのかな？

---

# プロセスへの新規メモリの割り当て

- Linux においてはメモリ獲得は以下の 2 つの手順に分かれている

1. メモリ領域の割り当て

   - 仮想アドレス空間に新規にアクセス可能なメモリ領域をマップする

1. メモリの割り当て

   - 上記メモリ領域に物理メモリを割り当てる

---

# メモリ領域の割り当て:mmap()システムコール

- 動作中のプロセスに新規メモリを割り当てるには mmap()システムコールを用いる
- mmap()システムコールはメモリ領域のサイズを指定する引数があり，このシステムコールが呼ばれると，カーネルのメモリ管理システムはプロセスのページテーブルを書き換えて要求されたサイズの領域をページテーブルに追加でマップした上でマップされた領域の先頭アドレスをプロセスに返す

---

# メモリの割り当て:デマンドページング

- mmap()システムコールの呼び出し直後，新規メモリ領域に対応する物理メモリはまだ存在しない
