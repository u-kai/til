---
marp: true
---

# IAM について

---

# この資料について

-   AWS を利用する上で不可欠な IAM について概要を抑えることを目的としたもの
-   IAMxxx について各リソースの違いがわかるようになる

---

# 目次

-   IAM とは?認証認可とは？
-   IAM の必要性
-   IAM Policy について
-   IAM User について
-   IAM Role について
-   IAM Role と User の違いについて

---

# IAM とは？

-   AWS Identity and Access Manager の略
-   AWS を利用する上での ID 管理，認証，認可のサービス
-   ちなみに IAM という言葉自体は AWS 以外の文脈でもよく使われる

    -   GCP のドキュメントから

        > > 誰(ID)がどのリソースに対してどのようなアクセス権(ロール)を持つかを定義することにより，アクセス権限を管理します.

以降では単に IAM と記載した場合は AWS IAM を指します

---

# ID？認証？認可？

-   言葉の意味から一つずつ説明します

---

# ID とは

-   文脈(コンテキスト)によって意味が変わるが，前ページの文脈だと
    **何かを指すための一意性のあるもの**
-   例

    -   会社コンテキスト
        -   社員 ID
    -   知人コンテキスト
        -   呼び名
    -   IAM コンテキスト
        -   AWSAccessKeyId

---

# 認証とは

-   何であるかを確認すること
-   認証の多くの方法が ID とパスワードなどの秘密情報の対を示すことによって確認する
-   IAM の場合は以下の通り
    -   ID
        -   AWSAccessKeyId
    -   秘密情報
        -   AWSSecretAccessKey

**認証が成功すると，ID で示されている本人であると認識される**

---

# 認可とは

-   権限を与えること
-   権限とはできること，できないこと
-   権限の例

    -   ファイルの読み取りはできるけど，書き込みはできない

-   AWS だと IAM Policy に権限を記述する

**認可が成功すると，与えられた権限のことをすることができる**

---

# 一旦整理

-   ID

    -   何かを示す一意の値
    -   IAM だと AWSAccessKeyId

-   認証

    -   ID や秘密情報を使って，その ID 本人であることを確認すること
    -   IAM だと AWSAccessKeyId と AWSSecretAccessKey

-   認可
    -   権限(できること／できないこと)を与えること

---

# IAM の必要性

---

# IAM の利用用途

## ほとんどの AWS サービスの API 呼び出しには，IAM をつかった認証認可が行われている

つまり AWS サービスの API を呼び出したい時には IAM が必要

もし IAM この世に存在しなければ AWS サービスの API 呼び出しに対して独自で認証認可の仕組みを構築するか，だれでも API を呼び出せて良いようになる

---

# IAM がない世界線

前ページのように IAM がないと自前で認証認可の仕組みを作成するか，だれでも API を呼び出せる状態を許容するかになる

例えば S3 を使ったシステムを考えてみる

IAM がないと

-   S3 のデータを誰でも閲覧できてしまいます
-   S3 のデータを改竄されてしまいます
-   S3 にマルウェアなどのウィルスをばら撒かれてしまいます

## こんなこと許容できるわけがないですよね？

---

# IAM がやってくれていること

AWS リソースの API を呼び出す際に，認証認可を行っている

## つまり，作成した AWS リソースを誰がどのように利用できるかを制御できる

---

# さっきの例だと

S3 へのアクセスはあるユーザーのみに限定するような IAM の設定をすると...

-   S3 のデータは誰でも閲覧できなくなります
-   悪意のある第三者は S3 のデータを改竄できなくなります
-   悪意のある第三者は S3 にマルウェアなどのウィルスをばら撒けなくなります

# 安心安全！あるべき姿!

IAM の必要性がわかったところで次からは具体的な IAM の構成要素を紹介

---

# IAM Policy

---

# IAM Policy とは

## 簡単にいうと権限の羅列

```json
{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::my-bucket/*"
        },
        {
            "Effect": "Deny",
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::my-bucket/*"
        }
    ]
}
```

---

# IAM Policy の利用用途

-   IAM Policy は 権限の羅列でしかなく,それが誰(何)に対しての権限なのかの情報はない
-   つまり IAM Policy だけでは意味がなく，誰(何)に対しての権限なのかを明示する必要がある
-   具体的には，IAM User や IAM Role, IAM Group に対して IAM Policy をアタッチすることで，誰(何)に対しての権限なのかを明示できる
-   ここで誰(何)に当たるのが IAM User や IAM Role, IAM Group の役目

### IAM Policy は権限の羅列で,IAM User などにアタッチして権限を与えるもの！

---

# IAM User

---

# IAM User とは

### 公式より

> IAM ユーザーは、AWS とやり取りするために IAM ユーザーを使用する人間のユーザーまたはワークロードを表します。AWS のユーザーは名前と認証情報で構成されます。

### 簡単にいうと,AWS と何か(人間でなくても良い)がやり取りする際に必要になるもの

---

# IAM User の実態 1:永続的な認証情報

-   IAM User には永続的なアクセスキーとシークレットアクセスキーが紐づいている

```bash
# example
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

-   AWS の API を叩く時にこの情報をリクエスト内に含める※ことで AWS 側が当該 IAM User による API リクエストだと判断(認証)することができる
-   Local PC やサーバなど に上記情報を保存し，プログラム内で利用することで，AWS リソースに対してリクエストすることができる

---

# IAM User の実態 2:Policy をアタッチして権限を得る

-   実は IAM User だけでは権限を持たない
-   IAM Policy を IAM User に付与してあげることで IAM User は権限を得ることができる

![](./create-iam-user.md)

-   いつでもアタッチ，デタッチが可能なので，権限を変えたい時は IAM User を変更せずともアタッチする IAM Policy を変更すれば良い!

---

# IAM User の作成から利用，Policy のアタッチまでの Demo

---

# IAM User の弱点

-   IAM User の特性として**永続的**な認証情報が紐づけられており，その認証情報によって認証が行われる

### つまり，IAM User に紐づいている認証情報が漏洩したら簡単に乗っ取りがされてしまう

---

# どうすればいいのか？

-   IAM User でやりたいことをもう一度考えると，AWS の API を叩く時の認証情報として利用したい
-   ただ，その情報が永久的なものなので，漏れるリスクが高いし，漏れたら終わり

### - では，認証情報がリクエストする時だけ有効，もしくは生存時間が短ければリスク緩和になるのでは？

## それを達成するのが IAM Role

---

# IAM Role とは

-   役割はほとんど IAM User と同じ
    -   認証情報が紐づいており Policy をアタッチすることで，AWS の API を叩く時に認証／認可の要素として利用される

### - ただし，認証情報は永続的ではなく，一時的に発行される!

### - 一時的な認証情報の有効期限は少ないかつ，発行のたびにことなる認証情報が作成される

---

# IAM Role の使い方 - 認証情報取得から利用まで

-   AWS の API の一つである AssumeRole というものを使うと，指定した IAM Role の一時的な認証情報を得ることができる
-   上記で取得できた認証情報を利用することで，当該 IAM Role に付与されている権限

---

# ここで疑問

-   AssumeRole を行うにも認証情報が必要そう
-   そうなると，AssumeRole する元の認証情報は永続的な IAM User じゃないといけないのでは？
-   そうなると，結局どこかに永続的な認証情報は持っていないといけないのでは？

### この点は IAM Role に指定する信頼関係(何であれば Assume Role することができるか)で解決する

---

# IAM Role の信頼関係

-   IAM Role には信頼関係の記述がマスト
-   信頼関係とは，誰であればこの Role に対して Assume Role して良いのか，悪いのかが記載されている
-   以下の例は AWS Lambda が以下の信頼関係を記述している IAM Role に対して Assume Role することができることを意味している

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

-   Principal が「誰か？」に当たるもの

---

# Principal の種類

-   AWS アカウント およびルートユーザー
-   IAM ロール
-   ロールセッション
-   IAM ユーザー
-   フェデレーティッドユーザーセッション
-   AWS のサービス
-   すべてのプリンシパル

---

# 補足:IAM User の認証情報一覧

### 実は IAM User はアクセスキー以外の認証情報も紐づけることができる

-   コンソールパスワード
    -   これでマネコンにログインできる
-   アクセスキー
    -   これを使って認証することで AWS の API を実行する権限を得る
-   CodeCommit で使用する SSH キー
    -   現在は GRC というアクセスキーのみで行える方法もあるので，あんま使わない？？？
-   サーバ証明書
    -   サーバ証明書用のサービスである ACM が利用できないリージョンの時にしょうがなしにつかうみたいで，非推奨

---

# Column：認証と認可の関係

-   ほとんどのサービスが認証後に認可を行う
    -   IAM もそのような流れ
-   ただし，必ずしも認証と認可はセットでなくても良い
-   例
    -   電車の切符
        -   切符を買う際に認証は不要だが，認可(電車に乗る権限)は付与される

---

# Column：認証と認可を分ける理由

**Q: ほとんどのサービスが認証後に認可するならば認証と認可は一緒でいいのでは？**

-   認可で与えられる権限は動的に変わりやすい
    -   部署移動したら権限は変わるはず
    -   イけているシステムは,ユーザーがいつもと違うところからアクセスしていたら認可する権限を弱めてセキュアにすることも
-   認証に利用するデータは静的な性質がある
    -   部署移動してもあなたはあなた
    -   どこからアクセスしても，怪しくても，認証突破後はあなたはあなた

**A:性質が異なるものを，分けることで，管理性とセキュリティを向上**
**A:性質が異なるものを，分けることで，管理性とセキュリティを向上**
**A:性質が異なるものを，分けることで，管理性とセキュリティを向上**
