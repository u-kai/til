# fork関数の高速化:コピーオンライト

- fork関数発行時には親プロセスのメモリを子プロセスにすべてコピーするのではなく、ページテーブルだけをコピーする
- ページテーブルエントリ内には、ページへの書き込み権限を示すフィールドがあるが、この時は親も子も全ページの書き込み権限を無効化する
- この後にメモリを読むと親子ともに共有された物理ページにアクセスできる
    - 一方、親子のいずれかがデータを更新しようとするとページの共有を解除してそれぞれのプロセスは専用のページを持つことになる

- 子プロセスがページのデータを更新しようとすると以下の手順になる
    - 書き込み権限がないのでCPU上でページフォルトが発生
    - CPUがカーネルモードに遷移してカーネルのページフォルトハンドラが動き出す
    - ページフォールトハンドラはアクセスされたページを別の物理メモリ上にコピーする
    - 親子プロセスともに子プロセスが変更しようとしたページに対応するページテーブルエントリを書き換える
        - 親プロセスのエントリは書き込み権限を有効化する
        - 子プロセスのエントリは処理のコピー先の領域を参照する